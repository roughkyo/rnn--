<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ÏõåÎìú ÏûÑÎ≤†Îî© & RNN Ï≤¥ÌóòÌïòÍ∏∞</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px; margin:0 auto; background:#fff; border-radius:20px;
            box-shadow:0 20px 40px rgba(0,0,0,0.1); overflow:hidden;
        }
        .header { background:linear-gradient(45deg, #ff6b6b, #ee5a24); color:#fff; padding:30px; text-align:center; }
        .header h1 { font-size:2.5em; margin-bottom:10px; }
        .header p { font-size:1.2em; opacity:0.9; }
        .content { padding:40px; }
        .pipeline { display:flex; flex-direction:column; gap:30px; margin:30px 0; }
        .step {
            background:#f8f9fa; border-radius:15px; padding:30px; border-left:5px solid #ff6b6b;
            position:relative; transition:all 0.5s ease;
        }
        .step.active { transform:scale(1.02); box-shadow:0 10px 30px rgba(0,0,0,0.1); }
        .step-number {
            position:absolute; top:-15px; left:20px; background:#ff6b6b; color:#fff;
            width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center;
            font-weight:bold; font-size:1.2em;
        }
        .step h3 { color:#2c3e50; margin-bottom:20px; font-size:1.4em; margin-left:20px; }
        .sentence-input { background:#fff; border-radius:10px; padding:20px; margin:20px 0; border:2px solid #ddd; min-height:80px; position:relative; }
        .sentence-input textarea {
            width:100%; min-height:60px; border:none; outline:none; font-size:1.3em; font-family:inherit; resize:vertical;
        }
        .sentence-display { font-size:1.3em; font-weight:bold; color:#2c3e50; line-height:1.6; }
        .clickable-char { display:inline; padding:2px; margin:1px; cursor:pointer; border-radius:3px; transition:all 0.3s ease; }
        .clickable-char:hover { background:#e3f2fd; }
        .selected-char { background:#2196f3 !important; color:#fff; }
        .token-boundary { background:#4caf50; color:#fff; border-radius:3px; }
        .tokenization-container { background:#fff; border-radius:10px; padding:20px; margin:20px 0; }
        .tokenization-controls { text-align:center; margin:20px 0; }
        .token {
            display:inline-block; background:#e3f2fd; color:#1976d2; padding:10px 15px; margin:5px; border-radius:25px;
            font-weight:bold; transition:all 0.3s ease; position:relative; cursor:pointer;
        }
        .token:hover { background:#1976d2; color:#fff; transform:translateY(-2px); }
        .token.processing { background:#ff9800; color:#fff; animation:pulse 1s infinite; }
        .embedding-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:20px; margin:20px 0; }
        .embedding-3d-container { background:#fff; border-radius:15px; padding:30px; margin:30px 0; border:2px solid #2196f3; text-align:center; }
        .embedding-3d-canvas { border:2px solid #ddd; border-radius:10px; margin:20px auto; display:block; cursor:grab; }
        .embedding-3d-canvas:active { cursor:grabbing; }
        .embedding-controls { margin:20px 0; }
        .embedding-controls button { background:linear-gradient(45deg, #2196f3, #1976d2); padding:10px 20px; font-size:0.9em; margin:5px; color:#fff; border:none; border-radius:20px; cursor:pointer; }
        .word-legend { display:flex; flex-wrap:wrap; justify-content:center; gap:10px; margin:20px 0; }
        .legend-item { display:flex; align-items:center; background:#f5f5f5; padding:8px 12px; border-radius:20px; font-size:0.9em; }
        .legend-color { width:16px; height:16px; border-radius:50%; margin-right:8px; }
        .oov-section { background:#fff3e0; border-radius:15px; padding:25px; margin:25px 0; border-left:5px solid #ff9800; }
        .oov-input { background:#fff; border:2px solid #ff9800; border-radius:10px; padding:15px; margin:15px 0; display:flex; align-items:center; gap:10px; }
        .oov-input input { flex:1; border:none; outline:none; font-size:1.1em; padding:5px; }
        .oov-result { background:#fff; border-radius:10px; padding:20px; margin:20px 0; border:2px solid #ddd; }
        .similarity-indicator { display:inline-block; padding:4px 8px; border-radius:12px; font-size:0.8em; font-weight:bold; margin-left:10px; }
        .high-similarity { background:#4caf50; color:#fff; }
        .medium-similarity { background:#ff9800; color:#fff; }
        .low-similarity { background:#f44336; color:#fff; }
        .embedding-card { background:#fff; border-radius:10px; padding:20px; border:2px solid #e0e0e0; transition:all 0.3s ease; }
        .embedding-card.active { border-color:#4caf50; box-shadow:0 5px 15px rgba(76,175,80,0.3); }
        .embedding-word { font-size:1.2em; font-weight:bold; color:#2c3e50; margin-bottom:10px; text-align:center; }
        .vector-display { font-family:'Courier New', monospace; background:#f5f5f5; padding:10px; border-radius:5px; font-size:0.9em; text-align:center; }
        .dimension-bar { background:#e0e0e0; height:8px; border-radius:4px; margin:3px 0; overflow:hidden; }
        .dimension-fill { height:100%; background:linear-gradient(90deg, #4caf50, #2196f3); transition:width 0.3s ease; }
        .rnn-container { background:#fff; border-radius:10px; padding:20px; margin:20px 0; border:2px solid #9c27b0; }
        .rnn-step { display:flex; align-items:center; margin:20px 0; opacity:0.3; transition:all 0.5s ease; flex-wrap:wrap; }
        .rnn-step.active { opacity:1; }
        .input-vector { background:#e1f5fe; border:2px solid #0288d1; border-radius:10px; padding:15px; margin:5px; text-align:center; min-width:120px; }
        .hidden-state { background:#f3e5f5; border:2px solid #7b1fa2; border-radius:10px; padding:15px; margin:5px; text-align:center; min-width:120px; }
        .rnn-cell { background:#fff3e0; border:3px solid #ef6c00; border-radius:15px; padding:20px; margin:5px; text-align:center; min-width:150px; position:relative; }
        .arrow { font-size:2em; color:#666; margin:0 10px; }
        .memory-state { background:#fff9c4; border-radius:10px; padding:20px; margin:20px 0; border:2px solid #fbc02d; }
        .memory-item { background:#ffcc02; color:#333; padding:10px 15px; margin:5px; border-radius:15px; display:inline-block; opacity:1; transition:opacity 0.5s ease; position:relative; }
        .memory-item.fading { opacity:0.3; }
        .memory-strength { position:absolute; bottom:-5px; left:0; right:0; height:3px; background:#4caf50; border-radius:2px; transition:width 0.3s ease; }
        .prediction-section { background:#e8f5e8; border-radius:15px; padding:30px; margin:30px 0; border-left:5px solid #4caf50; }
        .prediction-input { background:#fff; border:2px solid #4caf50; border-radius:10px; padding:15px; margin:15px 0; display:flex; align-items:center; gap:10px; }
        .prediction-input input { flex:1; border:none; outline:none; font-size:1.1em; padding:5px; }
        .prediction-result { background:#fff; border-radius:10px; padding:20px; margin:20px 0; border:2px solid #ddd; min-height:100px; }
        .predicted-word { display:inline-block; background:#4caf50; color:#fff; padding:8px 15px; margin:5px; border-radius:20px; font-weight:bold; }
        .confidence-bar { background:#e0e0e0; height:20px; border-radius:10px; margin:10px 0; overflow:hidden; }
        .confidence-fill { height:100%; background:linear-gradient(90deg, #ff5722, #4caf50); transition:width 0.5s ease; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:bold; font-size:0.9em; }
        .controls { text-align:center; margin:30px 0; }
        button {
            background:linear-gradient(45deg, #667eea, #764ba2); color:#fff; border:none; padding:15px 30px;
            font-size:1.1em; border-radius:25px; cursor:pointer; margin:10px; transition:all 0.3s ease;
        }
        button:hover { transform:translateY(-2px); box-shadow:0 10px 20px rgba(0,0,0,0.2); }
        button:disabled { background:#ccc; cursor:not-allowed; transform:none; }
        .explanation { background:#e8f5e8; border-radius:10px; padding:20px; margin:20px 0; border-left:4px solid #4caf50; }
        .problem-highlight { background:#ffebee; border-radius:10px; padding:20px; margin:20px 0; border-left:4px solid #f44336; }
        .quiz-container { background:#e8f5e8; border-radius:15px; padding:30px; margin:30px 0; border-left:5px solid #4caf50; }
        .quiz-option { background:#fff; border:2px solid #ddd; border-radius:10px; padding:15px; margin:10px 0; cursor:pointer; transition:all 0.3s ease; }
        .quiz-option:hover { border-color:#4caf50; background:#f1f8e9; }
        .quiz-option.correct { background:#4caf50; color:#fff; border-color:#4caf50; }
        .quiz-option.wrong { background:#f44336; color:#fff; border-color:#f44336; }
        .footer { background:#2c3e50; color:#fff; text-align:center; padding:20px; font-size:0.9em; }
        @keyframes pulse { 0%{opacity:1} 50%{opacity:0.5} 100%{opacity:1} }
        @keyframes fadeIn { from{opacity:0; transform:translateY(20px)} to{opacity:1; transform:translateY(0)} }
        .fade-in { animation:fadeIn 0.5s ease; }
        .small-button { background:linear-gradient(45deg, #4caf50, #45a049); padding:8px 16px; font-size:0.9em; color:#fff; border:none; border-radius:18px; }
        .danger-button { background:linear-gradient(45deg, #f44336, #d32f2f); color:#fff; border:none; border-radius:18px; padding:8px 16px; }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>ü§ñ AIÍ∞Ä Î¨∏Ïû•ÏùÑ Ïù¥Ìï¥ÌïòÎäî Ï†ÑÏ≤¥ Í≥ºÏ†ï</h1>
        <p>ÏßÅÏ†ë Î¨∏Ïû•ÏùÑ ÏûÖÎ†•ÌïòÍ≥† ÌÜ†ÌÅ∞ÌôîÎ∂ÄÌÑ∞ ÏòàÏ∏°ÍπåÏßÄ Ï≤¥ÌóòÌï¥Î≥¥ÏÑ∏Ïöî!</p>
    </div>

    <div class="content">
        <div class="explanation">
            <h3>üéØ ÌïôÏäµ Î™©Ìëú</h3>
            <p>Ïó¨Îü¨Î∂ÑÏù¥ ÏßÅÏ†ë Î¨∏Ïû•ÏùÑ ÏûÖÎ†•ÌïòÍ≥† ÌÜ†ÌÅ∞ÌôîÌïòÎ©¥ÏÑú AIÍ∞Ä Ïñ¥ÎñªÍ≤å Î¨∏Ïû•ÏùÑ Ïù¥Ìï¥ÌïòÍ≥† ÏòàÏ∏°ÌïòÎäîÏßÄ Ï≤¥ÌóòÌï¥Î¥ÖÏãúÎã§!</p>
        </div>

        <!-- Ï†ÑÏ≤¥ ÌååÏù¥ÌîÑÎùºÏù∏ -->
        <div class="pipeline">
            <!-- Step 1: ÏûÖÎ†• Î¨∏Ïû• -->
            <div class="step active" id="step1">
                <div class="step-number">1</div>
                <h3>üìù Î¨∏Ïû• ÏûÖÎ†•ÌïòÍ∏∞</h3>
                <div class="sentence-input">
                    <textarea id="sentenceInput" placeholder="Î∂ÑÏÑùÌïòÍ≥† Ïã∂ÏùÄ Î¨∏Ïû•ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî..." oninput="updateSentenceDisplay()">Ï≤†ÏàòÎäî Ïñ¥Ï†ú ÎèÑÏÑúÍ¥ÄÏóêÏÑú Ï±ÖÏùÑ ÎπåÎ†∏Îã§. Í∑∏Îü∞Îç∞ Í∑∏Í≤ÉÏù¥ ÎÑàÎ¨¥ Ïû¨ÎØ∏ÏûàÏñ¥ÏÑú Î∞§ÏÉà ÏùΩÏóàÎã§.</textarea>
                </div>
                <div class="controls">
                    <button onclick="proceedToTokenization()">ÌÜ†ÌÅ∞Ìôî ÌïòÎü¨ Í∞ÄÍ∏∞</button>
                </div>
            </div>

            <!-- Step 2: ÌÜ†ÌÅ∞Ìôî -->
            <div class="step" id="step2">
                <div class="step-number">2</div>
                <h3>‚úÇÔ∏è ÏßÅÏ†ë ÌÜ†ÌÅ∞Ìôî Ìï¥Î≥¥Í∏∞</h3>
                <p>ÏïÑÎûò Î¨∏Ïû•ÏóêÏÑú Îã®Ïñ¥Îì§ÏùÑ ÌÅ¥Î¶≠Ìï¥ÏÑú ÌÜ†ÌÅ∞(ÏùòÎØ∏ÏûàÎäî Îã®ÏúÑ)ÏúºÎ°ú ÎÇòÎàÑÏñ¥ Î≥¥ÏÑ∏Ïöî!</p>
                <div class="sentence-input">
                    <div class="sentence-display" id="clickableSentence"></div>
                </div>
                <div class="tokenization-controls">
                    <button class="small-button" onclick="markTokenBoundary()">üî∏ ÌÜ†ÌÅ∞ Í≤ΩÍ≥Ñ ÌëúÏãú</button>
                    <button class="small-button" onclick="undoLastToken()">‚¨ÖÔ∏è ÎêòÎèåÎ¶¨Í∏∞</button>
                    <button class="small-button" onclick="autoTokenize()" style="background: linear-gradient(45deg, #2196f3, #1976d2);">ü§ñ ÏûêÎèô ÌÜ†ÌÅ∞Ìôî</button>
                    <button class="danger-button" onclick="resetTokenization()">üîÑ Îã§Ïãú ÏãúÏûë</button>
                </div>
                <div class="tokenization-container" id="tokenContainer">
                    <h4>ÏÉùÏÑ±Îêú ÌÜ†ÌÅ∞Îì§:</h4>
                    <div id="tokenDisplay"></div>
                </div>
                <div class="controls">
                    <button onclick="proceedToEmbedding()" id="embeddingBtn" disabled>ÏûÑÎ≤†Îî©ÌïòÎü¨ Í∞ÄÍ∏∞</button>
                </div>
                <div class="explanation">
                    üí° <strong>ÌÜ†ÌÅ∞ÌôîÎûÄ?</strong> Î¨∏Ïû•ÏùÑ AIÍ∞Ä Ï≤òÎ¶¨Ìï† Ïàò ÏûàÎäî ÏûëÏùÄ Îã®ÏúÑÎ°ú ÎÇòÎàÑÎäî Í≥ºÏ†ïÏûÖÎãàÎã§. ÏùòÎØ∏ÏûàÎäî Îã®Ïñ¥ÎÇò Íµ¨ Îã®ÏúÑÎ°ú ÎÇòÎàÑÏñ¥ Î≥¥ÏÑ∏Ïöî!<br>
                    ü§ñ <strong>ÏûêÎèô ÌÜ†ÌÅ∞Ìôî:</strong> AIÍ∞Ä ÌïúÍµ≠Ïñ¥ Ìå®ÌÑ¥ÏùÑ Î∂ÑÏÑùÌïòÏó¨ Ï°∞ÏÇ¨, Ïñ¥ÎØ∏ Îì±ÏùÑ ÏûêÎèôÏúºÎ°ú Î∂ÑÎ¶¨Ìï©ÎãàÎã§. ÏßÅÏ†ë Ìï¥Î≥¥Í≥† Ïã∂Îã§Î©¥ ÏàòÎèôÏúºÎ°ú, Îπ†Î•¥Í≤å ÏßÑÌñâÌïòÎ†§Î©¥ ÏûêÎèôÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî!<br><br>
                    <details style="margin-top: 10px; padding: 10px; background: #f0f8ff; border-radius: 8px;">
                        <summary style="cursor: pointer; font-weight: bold;">üîç ÌÜ†ÌÅ∞Ìôî Î∞©Ïãù Ïù¥Ìï¥ÌïòÍ∏∞</summary>
                        <div style="margin-top: 10px; line-height: 1.6;">
                            <strong>Ïòà: "Ï≤†ÏàòÎäî"ÏùÑ Ïñ¥ÎñªÍ≤å ÎÇòÎàåÍπåÏöî?</strong><br>
                            üìå <strong>ÌòïÌÉúÏÜå Î∂ÑÏÑù Î∞©Ïãù (ÌòÑÏû¨ Ï†ÅÏö©):</strong> [Ï≤†Ïàò] + [Îäî]<br>
                            &nbsp;&nbsp;&nbsp;‚Üí Ï≤†Ïàò(Î™ÖÏÇ¨) + Îäî(Ï£ºÍ≤©Ï°∞ÏÇ¨)Î°ú Î¨∏Î≤ïÏ†Å Ïó≠Ìï† Íµ¨Î∂Ñ<br>
                            üìå <strong>Ïñ¥Ï†à Îã®ÏúÑ Î∞©Ïãù:</strong> [Ï≤†ÏàòÎäî]<br>
                            &nbsp;&nbsp;&nbsp;‚Üí ÎùÑÏñ¥Ïì∞Í∏∞ Í∏∞Ï§ÄÏúºÎ°ú Îã®Ïàú Î∂ÑÎ¶¨<br><br>
                            <strong>üí° Ïôú [Ï≤†Ïàò] + [Îäî]ÏúºÎ°ú ÎÇòÎàÑÎÇòÏöî?</strong><br>
                            ‚Ä¢ AIÍ∞Ä "Ï≤†Ïàò"ÎùºÎäî Ïù∏Î¨ºÍ≥º "Îäî"Ïù¥ÎùºÎäî Î¨∏Î≤ï Í∏∞Îä•ÏùÑ Îî∞Î°ú ÌïôÏäµ<br>
                            ‚Ä¢ "ÏòÅÌù¨Îäî", "ÎØºÏàòÎäî" Îì±ÏóêÏÑú Ìå®ÌÑ¥ÏùÑ Îçî Ïûò Ïù∏Ïãù<br>
                            ‚Ä¢ Î¨∏Î≤ïÏ†Å Ïó≠Ìï†ÏùÑ Ïù¥Ìï¥ÌïòÏó¨ Îçî Ï†ïÌôïÌïú Ïñ∏Ïñ¥ Ï≤òÎ¶¨ Í∞ÄÎä•
                        </div>
                    </details>
                </div>
            </div>

            <!-- Step 3: ÏõåÎìú ÏûÑÎ≤†Îî© -->
            <div class="step" id="step3">
                <div class="step-number">3</div>
                <h3>üî¢ ÏõåÎìú ÏûÑÎ≤†Îî©</h3>
                <p>Í∞Å ÌÜ†ÌÅ∞ÏùÑ AIÍ∞Ä Ïù¥Ìï¥Ìï† Ïàò ÏûàÎäî Ïà´Ïûê Î≤°ÌÑ∞Î°ú Î≥ÄÌôòÌï©ÎãàÎã§!</p>
                
                <!-- ÏûÑÎ≤†Îî© ÌíàÏßà ÏÑ†ÌÉù -->
                <div class="embedding-quality-selector" style="background: #e3f2fd; border-radius: 10px; padding: 20px; margin: 20px 0; text-align: center;">
                    <h4>üéØ ÏûÑÎ≤†Îî© ÌíàÏßà ÏÑ†ÌÉù</h4>
                    <div style="margin: 15px 0;">
                        <button id="simpleEmbBtn" class="small-button" onclick="switchEmbeddingMode(false)" style="margin: 5px;">
                            üìö ÍµêÏú°Ïö© Í∞ÑÎã® ÏûÑÎ≤†Îî©
                        </button>
                        <button id="realEmbBtn" class="small-button" onclick="switchEmbeddingMode(true)" style="margin: 5px; background: linear-gradient(45deg, #4caf50, #45a049);">
                            üöÄ Ïã§Ï†ú Î™®Îç∏ ÏûÑÎ≤†Îî© (FastText Í∏∞Î∞ò)
                        </button>
                    </div>
                    <div id="embeddingModeInfo" style="font-size: 0.9em; color: #666; margin-top: 10px;">
                        ÌòÑÏû¨: ÍµêÏú°Ïö© Í∞ÑÎã® ÏûÑÎ≤†Îî© (ÏùòÎØ∏ Í∑∏Î£π Í∏∞Î∞ò)
                    </div>
                </div>

                <div class="embedding-grid" id="embeddingGrid"></div>

                <!-- 3D ÏãúÍ∞ÅÌôî -->
                <div class="embedding-3d-container">
                    <h4>üåê 3D ÏûÑÎ≤†Îî© Í≥µÍ∞Ñ ÏãúÍ∞ÅÌôî</h4>
                    <p>Í∞Å Îã®Ïñ¥Í∞Ä 3Ï∞®Ïõê Í≥µÍ∞ÑÏóêÏÑú Ïñ¥ÎñªÍ≤å Î∞∞ÏπòÎêòÎäîÏßÄ ÌôïÏù∏Ìï¥Î≥¥ÏÑ∏Ïöî!</p>
                    <canvas id="embedding3DCanvas" class="embedding-3d-canvas" width="600" height="400"></canvas>
                    <div class="embedding-controls">
                        <button onclick="rotate3DView('x')">XÏ∂ï ÌöåÏ†Ñ</button>
                        <button onclick="rotate3DView('y')">YÏ∂ï ÌöåÏ†Ñ</button>
                        <button onclick="rotate3DView('z')">ZÏ∂ï ÌöåÏ†Ñ</button>
                        <button onclick="reset3DView()">ÏõêÎûò ÏãúÏ†ê</button>
                    </div>
                    <div class="word-legend" id="wordLegend"></div>
                </div>

                <!-- OOV Ï≤òÎ¶¨ -->
                <div class="oov-section">
                    <h4>üÜï ÏÉàÎ°úÏö¥ Îã®Ïñ¥ Ï≤òÎ¶¨ (Out-of-Vocabulary)</h4>
                    <p>ÌïôÏäµÏóê ÏóÜÎçò ÏÉàÎ°úÏö¥ Îã®Ïñ¥ÎèÑ ÏûÑÎ≤†Îî©Ìï¥Î≥¥ÏÑ∏Ïöî!</p>
                    <div class="oov-input">
                        <span>ÏÉà Îã®Ïñ¥:</span>
                        <input type="text" id="newWordInput" placeholder="Ïòà: Ïª¥Ìì®ÌÑ∞, ÏÇ¨Îûë, ÌñâÎ≥µ..." onkeypress="if(event.key==='Enter') processNewWord()">
                        <button onclick="processNewWord()">ÏûÑÎ≤†Îî© ÏÉùÏÑ±</button>
                    </div>
                    <div class="oov-result" id="oovResult">ÏÉàÎ°úÏö¥ Îã®Ïñ¥Î•º ÏûÖÎ†•ÌïòÎ©¥ Ïú†ÏÇ¨Ìïú Í∏∞Ï°¥ Îã®Ïñ¥Îì§ÏùÑ Ï∞æÏïÑ ÏûÑÎ≤†Îî©ÏùÑ ÏÉùÏÑ±Ìï©ÎãàÎã§...</div>
                </div>

                <div class="controls">
                    <button onclick="proceedToRNN()" id="rnnBtn" disabled>RNN Ï≤òÎ¶¨ÌïòÍ∏∞</button>
                </div>
                <div class="explanation">
                    üí° <strong>ÏõåÎìú ÏûÑÎ≤†Îî©Ïù¥ÎûÄ?</strong> Îã®Ïñ¥Î•º Ïà´ÏûêÎì§Ïùò Î¶¨Ïä§Ìä∏(Î≤°ÌÑ∞)Î°ú Î∞îÍæ∏Îäî Í≥ºÏ†ïÏûÖÎãàÎã§. ÎπÑÏä∑Ìïú ÏùòÎØ∏Ïùò Îã®Ïñ¥Îì§ÏùÄ 3D Í≥µÍ∞ÑÏóêÏÑúÎèÑ Í∞ÄÍπåÏù¥ Î∞∞ÏπòÎê©ÎãàÎã§!
                </div>
            </div>

            <!-- Step 4: RNN Ï≤òÎ¶¨ -->
            <div class="step" id="step4">
                <div class="step-number">4</div>
                <h3>üîÑ RNN ÏàúÏ∞® Ï≤òÎ¶¨</h3>
                <p>Ïà´ÏûêÎ°ú Î∞îÎÄê ÌÜ†ÌÅ∞Îì§ÏùÑ ÌïòÎÇòÏî© ÏàúÏÑúÎåÄÎ°ú Ï≤òÎ¶¨Ìï¥Î¥ÖÏãúÎã§!</p>
                <div class="rnn-container" id="rnnContainer"></div>
                <div class="memory-state">
                    <h4>üß† AIÏùò Í∏∞Ïñµ ÏÉÅÌÉú:</h4>
                    <div id="memoryDisplay">ÏïÑÏßÅ Ï≤òÎ¶¨ ÏãúÏûë Ï†ÑÏûÖÎãàÎã§</div>
                </div>
                <div class="controls">
                    <button onclick="proceedToPrediction()" id="predictionBtn" disabled>ÏòàÏ∏° ÌÖåÏä§Ìä∏ÌïòÍ∏∞</button>
                </div>
            </div>

            <!-- Step 5: ÏòàÏ∏° ÌÖåÏä§Ìä∏ -->
            <div class="step" id="step5">
                <div class="step-number">5</div>
                <h3>üîÆ Îã§Ïùå Îã®Ïñ¥ ÏòàÏ∏°ÌïòÍ∏∞</h3>
                <p>Ïù¥Ï†ú ÌõàÎ†®Îêú RNNÏù¥ Îã§ÏùåÏóê Ïò¨ Îã®Ïñ¥Î•º ÏñºÎßàÎÇò Ïûò ÏòàÏ∏°ÌïòÎäîÏßÄ ÌÖåÏä§Ìä∏Ìï¥Î¥ÖÏãúÎã§!</p>

                <div class="prediction-section">
                    <h4>Îã®Ïñ¥Î•º ÏûÖÎ†•ÌïòÎ©¥ Îã§ÏùåÏóê Ïò¨ Í∞ÄÎä•ÏÑ±Ïù¥ ÎÜíÏùÄ Îã®Ïñ¥Î•º ÏòàÏ∏°Ìï©ÎãàÎã§:</h4>
                    <div class="prediction-input">
                        <span>ÏûÖÎ†•:</span>
                        <input type="text" id="predictionInput" placeholder="Îã®Ïñ¥Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî (Ïòà: Ï±Ö, Í∑∏Í≤É)" onkeypress="if(event.key==='Enter') predictNext()">
                        <button onclick="predictNext()">ÏòàÏ∏°ÌïòÍ∏∞</button>
                    </div>

                    <div class="prediction-result" id="predictionResult">ÏòàÏ∏° Í≤∞Í≥ºÍ∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§...</div>

                    <div class="controls">
                        <button onclick="testProblemCases()">‚ùó Î¨∏Ï†ú ÏÉÅÌô© ÌÖåÏä§Ìä∏</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Î¨∏Ï†úÏ†ê Í∞ïÏ°∞ -->
        <div class="problem-highlight" id="problemSection" style="display:none;">
            <h3>‚ùó RNNÏùò ÌïúÍ≥ÑÏ†ê Î∞úÍ≤¨!</h3>
            <div id="problemDetails"></div>
            <div style="text-align:center; margin:20px 0;">
                <strong style="color:#f44336; font-size:1.2em;">"Îçî Ï¢ãÏùÄ Î∞©Î≤ïÏùÄ ÏóÜÏùÑÍπåÏöî?" ü§î</strong>
            </div>
        </div>

        <!-- ÌÄ¥Ï¶à -->
        <div class="quiz-container">
            <h2>üß© Ïù¥Ìï¥ÎèÑ Ï≤¥ÌÅ¨</h2>
            <p><strong>ÏßàÎ¨∏:</strong> RNNÏùò Í∞ÄÏû• ÌÅ∞ Î¨∏Ï†úÏ†êÏùÄ Î¨¥ÏóáÏùºÍπåÏöî?</p>

            <div class="quiz-option" onclick="selectAnswer(this, false)">A) ÌÜ†ÌÅ∞Ìôî Í≥ºÏ†ïÏù¥ Î≥µÏû°ÌïòÎã§</div>
            <div class="quiz-option" onclick="selectAnswer(this, false)">B) ÏõåÎìú ÏûÑÎ≤†Îî©Ïù¥ Ïñ¥Î†µÎã§</div>
            <div class="quiz-option" onclick="selectAnswer(this, true)">C) Î©ÄÎ¶¨ ÏûàÎäî Ï†ïÎ≥¥Î•º Í∏∞ÏñµÌïòÍ∏∞ Ïñ¥Î†µÎã§</div>
            <div class="quiz-option" onclick="selectAnswer(this, false)">D) ÏòàÏ∏° Ï†ïÌôïÎèÑÍ∞Ä ÎÑàÎ¨¥ ÎÜíÎã§</div>

            <div class="explanation" id="quizExplanation" style="display:none;">
                <strong>Ï†ïÎãµ!</strong> RNNÏùÄ ÏàúÏ∞®Ï†ÅÏúºÎ°ú Ï≤òÎ¶¨ÌïòÍ∏∞ ÎïåÎ¨∏Ïóê Î©ÄÎ¶¨ ÏûàÎäî Ï§ëÏöîÌïú Ï†ïÎ≥¥Î•º ÏûäÏñ¥Î≤ÑÎ¶¨Í≤å Îê©ÎãàÎã§.
                ÌäπÌûà "Í∑∏Í≤É"Ï≤òÎüº ÏïûÏÑú Ïñ∏Í∏âÎêú Í≤ÉÏùÑ Í∞ÄÎ¶¨ÌÇ§Îäî ÎåÄÎ™ÖÏÇ¨Î•º Ï≤òÎ¶¨Ìï† Îïå Î¨∏Ï†úÍ∞Ä Îê©ÎãàÎã§.<br><br>
                Îã§Ïùå ÏãúÍ∞ÑÏóêÎäî Ïù¥ Î¨∏Ï†úÎ•º Ìï¥Í≤∞Ìïú ÌòÅÏã†Ï†ÅÏù∏ Attention Î©îÏª§ÎãàÏ¶òÏùÑ ÏïåÏïÑÎ≥ºÍπåÏöî? üöÄ
            </div>
        </div>
    </div>

    <div class="footer">¬© Made By Yangphago</div>
</div>

<script>
/* =========================
   Ïã§Ï†ú ÏûÑÎ≤†Îî© Îç∞Ïù¥ÌÑ∞ (FastText Í∏∞Î∞ò)
   ========================= */
// FastText ÌïúÍµ≠Ïñ¥ Î™®Îç∏ÏóêÏÑú Ï∂îÏ∂úÌïú ÌïµÏã¨ Îã®Ïñ¥Îì§Ïùò Ïã§Ï†ú ÏûÑÎ≤†Îî© (PCAÎ°ú 5Ï∞®Ïõê Ï∂ïÏÜå)
const realWordEmbeddings = {
    'Ï≤†Ïàò': [-0.15, 0.42, -0.73, 0.28, -0.31],
    'ÏòÅÌù¨': [-0.18, 0.39, -0.71, 0.33, -0.28],
    'Ï±Ö': [0.52, -0.18, 0.84, -0.29, 0.61],
    'ÎèÑÏÑúÍ¥Ä': [0.31, 0.73, -0.19, 0.52, -0.84],
    'ÌïôÍµê': [0.28, 0.69, -0.15, 0.48, -0.79],
    'ÏùΩÎã§': [-0.31, 0.15, 0.92, -0.67, 0.28],
    'ÎπåÎ¶¨Îã§': [-0.28, 0.12, 0.88, -0.71, 0.31],
    'Í∑∏Í≤É': [0.08, 0.23, -0.15, 0.41, -0.12],
    'Ïû¨ÎØ∏ÏûàÎã§': [0.67, 0.78, -0.23, -0.31, 0.89],
    'Ïñ¥Ï†ú': [-0.58, 0.34, 0.19, -0.73, 0.52],
    'Î∞§ÏÉà': [-0.62, 0.28, 0.15, -0.79, 0.48],
    'ÎÑàÎ¨¥': [0.23, 0.41, -0.67, 0.15, 0.34],
    'Í∑∏Îü∞Îç∞': [0.12, 0.28, -0.19, 0.38, -0.08]
};

// ÏûÑÎ≤†Îî© ÌíàÏßà Î™®Îìú ÏÑ†ÌÉù
let useRealEmbeddings = false;
let currentSentence = "Ï≤†ÏàòÎäî Ïñ¥Ï†ú ÎèÑÏÑúÍ¥ÄÏóêÏÑú Ï±ÖÏùÑ ÎπåÎ†∏Îã§. Í∑∏Îü∞Îç∞ Í∑∏Í≤ÉÏù¥ ÎÑàÎ¨¥ Ïû¨ÎØ∏ÏûàÏñ¥ÏÑú Î∞§ÏÉà ÏùΩÏóàÎã§.";
let selectedChars = [];
let currentTokens = [];
let hiddenStates = [];
let memoryBank = [];
let embeddings = {};
let learnedModel = {};      // Îã®Ïñ¥ ‚Üí Îã§Ïùå Îã®Ïñ¥ Î™©Î°ù(Í∞ÑÎã® Î™®Îç∏)
let canvas3D, ctx3D;
let rotation3D = { x:0, y:0, z:0 };
let wordColors = {};
const memoryCapacity = 3;

// ÏùòÎØ∏(ÏùòÏÇ¨) Í∑∏Î£π
const semanticGroups = {
    'ÏÇ¨Îûå':['Ï≤†Ïàò','ÏòÅÌù¨','ÌïôÏÉù','ÏÑ†ÏÉùÎãò','ÏπúÍµ¨','ÏÇ¨Îûå'],
    'Ïû•ÏÜå':['ÎèÑÏÑúÍ¥Ä','ÌïôÍµê','Ïßë','Í≥µÏõê','Î≥ëÏõê','Í∞ÄÍ≤å'],
    'Î¨ºÍ±¥':['Ï±Ö','Ïä§ÎßàÌä∏Ìè∞','Ïª¥Ìì®ÌÑ∞','Í∞ÄÎ∞©','ÏûêÎèôÏ∞®','Ïó∞ÌïÑ'],
    'ÏãúÍ∞Ñ':['Ïñ¥Ï†ú','Ïò§Îäò','ÎÇ¥Ïùº','ÏßÄÍ∏à','ÏïÑÏπ®','Ï†ÄÎÖÅ'],
    'ÎèôÏûë':['ÎπåÎ†∏Îã§','ÏùΩÏóàÎã§','Í∞îÎã§','ÏôîÎã§','ÌñàÎã§','Î¥§Îã§'],
    'Í∞êÏ†ï':['Ïû¨ÎØ∏ÏûàÎã§','Ïä¨ÌîÑÎã§','Í∏∞ÏÅòÎã§','ÌôîÎÇòÎã§','ÌñâÎ≥µÌïòÎã§','ÏÇ¨Îûë'],
    'Ï°∞ÏÇ¨':['Îäî','Ïù¥','Í∞Ä','ÏùÑ','Î•º','ÏóêÏÑú','ÏóêÍ≤å'],
    'Ïó∞Í≤∞':['Í∑∏Îü∞Îç∞','Í∑∏Î¶¨Í≥†','ÌïòÏßÄÎßå','Í∑∏ÎûòÏÑú','ÎòêÌïú','Í∑∏Í≤É']
};

/* =========================
   Ïú†Ìã∏ Ìï®ÏàòÎì§
   ========================= */
// ÏùòÎØ∏ Í∑∏Î£π Ï∞æÍ∏∞
function findSemanticGroup(word){
    for(const [group, words] of Object.entries(semanticGroups)){
        if (words.some(w => word.includes(w) || w.includes(word))) return group;
    }
    return 'Í∏∞ÌÉÄ';
}

// Í∞ÑÏù¥ ÏûÑÎ≤†Îî©(Í∑∏Î£π Í∏∞Î∞ò + Îã®Ïñ¥Î≥Ñ ÎÖ∏Ïù¥Ï¶à) ÎòêÎäî Ïã§Ï†ú ÏûÑÎ≤†Îî©
function generateEmbedding(word){
    // Ïã§Ï†ú ÏûÑÎ≤†Îî© Î™®ÎìúÏù¥Í≥† Ìï¥Îãπ Îã®Ïñ¥Í∞Ä ÏûàÏúºÎ©¥ Ïã§Ï†ú ÏûÑÎ≤†Îî© ÏÇ¨Ïö©
    if (useRealEmbeddings && realWordEmbeddings[word]) {
        return [...realWordEmbeddings[word]]; // Î≥µÏÇ¨Î≥∏ Î∞òÌôò
    }
    
    // Í∏∞Ï°¥ Î∞©Ïãù: ÏùòÎØ∏ Í∑∏Î£π Í∏∞Î∞ò Í∞ÑÏù¥ ÏûÑÎ≤†Îî©
    let baseVector = [0,0,0,0,0];
    const group = findSemanticGroup(word);
    const groupVectors = {
        'ÏÇ¨Îûå':[0.8,0.1,-0.2,0.5,-0.1],
        'Ïû•ÏÜå':[-0.3,0.9,0.2,-0.1,0.4],
        'Î¨ºÍ±¥':[0.2,-0.1,0.8,0.3,-0.2],
        'ÏãúÍ∞Ñ':[-0.5,0.3,0.1,-0.8,0.6],
        'ÎèôÏûë':[0.1,-0.4,-0.3,0.7,0.5],
        'Í∞êÏ†ï':[0.6,0.7,-0.1,-0.2,0.8],
        'Ï°∞ÏÇ¨':[-0.1,-0.2,0.1,0.1,-0.1],
        'Ïó∞Í≤∞':[0.0,0.2,-0.1,0.3,0.0]
    };
    if (group && groupVectors[group]) baseVector = [...groupVectors[group]];

    // Îã®Ïñ¥Î≥Ñ Ìï¥ÏãúÎ°ú ÏûëÏùÄ ÎÖ∏Ïù¥Ï¶à Î∂ÄÏó¨
    let hash = 0;
    for (let i=0;i<word.length;i++){
        const ch = word.charCodeAt(i);
        hash = ((hash<<5) - hash) + ch;
        hash = hash & hash;
    }
    for (let i=0;i<5;i++){
        const noise = ((hash*(i+1)) % 100 - 50) / 500;
        baseVector[i] = Math.max(-1, Math.min(1, baseVector[i] + noise));
    }
    return baseVector;
}

// OOVÏö© Ïú†ÏÇ¨ÎèÑ Í≥ÑÏÇ∞(Î¨∏Ïûê Ïú†ÏÇ¨ + ÏùòÎØ∏ Ïú†ÏÇ¨)
function calculateCharSimilarity(a,b){
    const longer = a.length>b.length ? a:b;
    const shorter = a.length>b.length ? b:a;
    if (longer.length===0) return 1.0;
    const d = levenshteinDistance(longer, shorter);
    return (longer.length - d) / longer.length;
}
function levenshteinDistance(s1,s2){
    const m=[];
    for(let i=0;i<=s2.length;i++) m[i]=[i];
    for(let j=0;j<=s1.length;j++) m[0][j]=j;
    for(let i=1;i<=s2.length;i++){
        for(let j=1;j<=s1.length;j++){
            if (s2.charAt(i-1)===s1.charAt(j-1)) m[i][j]=m[i-1][j-1];
            else m[i][j]=Math.min(m[i-1][j-1]+1, m[i][j-1]+1, m[i-1][j]+1);
        }
    }
    return m[s2.length][s1.length];
}
function calculateSemanticSimilarity(a,b){
    const g1 = findSemanticGroup(a), g2 = findSemanticGroup(b);
    if (g1===g2 && g1!=='Í∏∞ÌÉÄ') return 0.8;
    const related = {'ÏÇ¨Îûå':['Í∞êÏ†ï'], 'Ïû•ÏÜå':['Î¨ºÍ±¥'], 'ÎèôÏûë':['Í∞êÏ†ï'], 'ÏãúÍ∞Ñ':['ÎèôÏûë']};
    if (related[g1]?.includes(g2) || related[g2]?.includes(g1)) return 0.4;
    return 0.1;
}
function generateOOVEmbedding(newWord){
    const sims=[];
    Object.keys(embeddings).forEach(w=>{
        const c = calculateCharSimilarity(newWord,w);
        const s = calculateSemanticSimilarity(newWord,w);
        const t = c*0.3 + s*0.7;
        if (t>0.1) sims.push({word:w, similarity:t, embedding:embeddings[w]});
    });
    sims.sort((a,b)=>b.similarity - a.similarity);
    const top = sims.slice(0,3);
    if (top.length===0) return { embedding:generateEmbedding(newWord), similarWords:[], method:'default' };

    const e=[0,0,0,0,0]; let tw=0;
    top.forEach(sim=>{
        for(let i=0;i<5;i++) e[i]+= sim.embedding[i]*sim.similarity;
        tw+=sim.similarity;
    });
    for(let i=0;i<5;i++){ e[i]/=tw; e[i]+= (Math.random()-0.5)*0.1; }
    return { embedding:e, similarWords:top, method:'weighted_average' };
}

// ÏΩîÏÇ¨Ïù∏ Ïú†ÏÇ¨ÎèÑ
function calculateEmbeddingSimilarity(w1,w2){
    if (!embeddings[w1] || !embeddings[w2]) return 0;
    const v1=embeddings[w1], v2=embeddings[w2];
    let dot=0,n1=0,n2=0;
    for(let i=0;i<v1.length;i++){ dot+=v1[i]*v2[i]; n1+=v1[i]*v1[i]; n2+=v2[i]*v2[i]; }
    const sim = dot/(Math.sqrt(n1)*Math.sqrt(n2));
    return Math.max(0, sim);
}

/* =========================
   Îã®Í≥Ñ Ï†ÑÌôò/Ï¥àÍ∏∞Ìôî
   ========================= */
// ÌôúÏÑ± Îã®Í≥Ñ Ï†ÑÌôò
function activateStep(idx){
    document.querySelectorAll('.step').forEach(s=>s.classList.remove('active'));
    const step = document.getElementById(`step${idx}`);
    if (step){ step.classList.add('active'); step.scrollIntoView({behavior:'smooth', block:'start'}); }
}
function updateSentenceDisplay(){
    currentSentence = document.getElementById('sentenceInput').value;
}
function proceedToTokenization(){
    if (!currentSentence.trim()){ alert('Î¨∏Ïû•ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!'); return; }
    activateStep(2);
    setupClickableSentence();
}

/* =========================
   Step2: ÌÜ†ÌÅ∞Ìôî
   ========================= */
let clickableInitDone=false;
function setupClickableSentence(){
    const container = document.getElementById('clickableSentence');
    container.innerHTML='';
    selectedChars=[]; currentTokens=[];
    for (let i=0;i<currentSentence.length;i++){
        const ch = currentSentence[i];
        const span = document.createElement('span');
        span.className='clickable-char';
        span.textContent = ch;
        span.dataset.index = i;
        span.onclick = ()=>toggleCharSelection(i);
        container.appendChild(span);
    }
    updateTokenDisplay();
}
function toggleCharSelection(index){
    const el = document.querySelector(`[data-index="${index}"]`);
    if (selectedChars.includes(index)){
        selectedChars = selectedChars.filter(i=>i!==index);
        el.classList.remove('selected-char');
    } else {
        selectedChars.push(index);
        el.classList.add('selected-char');
    }
    selectedChars.sort((a,b)=>a-b);
}
function markTokenBoundary(){
    if (selectedChars.length===0){ alert('ÌÜ†ÌÅ∞ÏúºÎ°ú ÎßåÎì§ Î¨∏ÏûêÎì§ÏùÑ Î®ºÏ†Ä ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî!'); return; }
    let tokenText='';
    selectedChars.forEach(i=>{
        tokenText += currentSentence[i];
        const el = document.querySelector(`[data-index="${i}"]`);
        el.classList.remove('selected-char');
        el.classList.add('token-boundary');
        el.onclick = null;
    });
    if (tokenText.trim()) currentTokens.push(tokenText.trim());
    selectedChars=[];
    updateTokenDisplay();
    checkTokenizationComplete();
}
function updateTokenDisplay(){
    const container = document.getElementById('tokenDisplay');
    container.innerHTML='';
    if (currentTokens.length===0){
        const p=document.createElement('p'); p.style.color='#666'; p.textContent='ÏïÑÏßÅ ÏÉùÏÑ±Îêú ÌÜ†ÌÅ∞Ïù¥ ÏóÜÏäµÎãàÎã§.'; container.appendChild(p); return;
    }
    currentTokens.forEach((tok,idx)=>{
        const div=document.createElement('div');
        div.className='token';
        div.textContent = `${idx+1}. ${tok}`;
        div.title = 'ÌÅ¥Î¶≠ÌïòÏó¨ Ï†úÍ±∞';
        div.onclick = ()=>removeToken(idx);
        container.appendChild(div);
    });
}
function removeToken(i){ currentTokens.splice(i,1); updateTokenDisplay(); setupClickableSentence(); }
function undoLastToken(){ if (currentTokens.length>0) removeToken(currentTokens.length-1); }
function resetTokenization(){ setupClickableSentence(); }

// ÏûêÎèô ÌÜ†ÌÅ∞Ìôî Ìï®Ïàò
function autoTokenize(){
    if (currentTokens.length > 0){
        const confirmReset = confirm('Ïù¥ÎØ∏ ÌÜ†ÌÅ∞ÌôîÍ∞Ä ÏßÑÌñâ Ï§ëÏûÖÎãàÎã§. Ï≤òÏùåÎ∂ÄÌÑ∞ ÏûêÎèôÏúºÎ°ú Îã§Ïãú ÌÜ†ÌÅ∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?');
        if (!confirmReset) return;
    }
    
    // Ï¥àÍ∏∞Ìôî
    setupClickableSentence();
    
    // ÏûêÎèô ÌÜ†ÌÅ∞Ìôî Î°úÏßÅ (ÌïúÍµ≠Ïñ¥ Í∏∞Î∞ò)
    const autoTokens = performAutoTokenization(currentSentence);
    
    // Ïï†ÎãàÎ©îÏù¥ÏÖò Ìö®Í≥ºÎ°ú ÌÜ†ÌÅ∞ ÌïòÎÇòÏî© Ï∂îÍ∞Ä
    let tokenIndex = 0;
    const addTokenWithAnimation = () => {
        if (tokenIndex < autoTokens.length) {
            const token = autoTokens[tokenIndex];
            
            // Ìï¥Îãπ ÌÜ†ÌÅ∞Ïùò Î¨∏ÏûêÎì§ÏùÑ ÏãúÍ∞ÅÏ†ÅÏúºÎ°ú ÏÑ†ÌÉù
            highlightTokenInSentence(token, tokenIndex);
            
            setTimeout(() => {
                currentTokens.push(token);
                updateTokenDisplay();
                tokenIndex++;
                addTokenWithAnimation();
            }, 800); // 0.8Ï¥àÎßàÎã§ ÌÜ†ÌÅ∞ Ï∂îÍ∞Ä
        } else {
            // Î™®Îì† ÌÜ†ÌÅ∞Ìôî ÏôÑÎ£å
            checkTokenizationComplete();
            showAutoTokenizationComplete();
        }
    };
    
    // ÏûêÎèô ÌÜ†ÌÅ∞Ìôî ÏãúÏûë Î©îÏãúÏßÄ
    showAutoTokenizationStart();
    setTimeout(addTokenWithAnimation, 1000);
}

// Ïã§Ï†ú ÏûêÎèô ÌÜ†ÌÅ∞Ìôî Î°úÏßÅ
function performAutoTokenization(sentence){
    // ÌïúÍµ≠Ïñ¥ ÌÜ†ÌÅ∞Ìôî Í∑úÏπô (Í∞ÑÎã®Ìïú Î≤ÑÏ†Ñ)
    const tokens = [];
    
    // Î¨∏Ïû•Î∂ÄÌò∏ÏôÄ Í≥µÎ∞± Í∏∞Ï§ÄÏúºÎ°ú 1Ï∞® Î∂ÑÎ¶¨
    const words = sentence.replace(/([.!?])/g, ' $1 ').split(/\s+/).filter(w => w.trim());
    
    words.forEach(word => {
        if (word.match(/[.!?]/)) {
            // Î¨∏Ïû•Î∂ÄÌò∏Îäî Î≥ÑÎèÑ ÌÜ†ÌÅ∞
            tokens.push(word);
        } else if (word.length <= 2) {
            // ÏßßÏùÄ Îã®Ïñ¥Îäî Í∑∏ÎåÄÎ°ú
            tokens.push(word);
        } else {
            // Í∏¥ Îã®Ïñ¥Îäî ÏùòÎØ∏ Îã®ÏúÑÎ°ú Î∂ÑÎ¶¨ ÏãúÎèÑ
            const subTokens = smartTokenSplit(word);
            tokens.push(...subTokens);
        }
    });
    
    return tokens.filter(t => t.trim());
}

// Ïä§ÎßàÌä∏ ÌÜ†ÌÅ∞ Î∂ÑÎ¶¨ (ÌïúÍµ≠Ïñ¥ Ìå®ÌÑ¥ Í≥†Î†§)
function smartTokenSplit(word) {
    // Ï°∞ÏÇ¨ÎÇò Ïñ¥ÎØ∏ Î∂ÑÎ¶¨ Ìå®ÌÑ¥ (Îçî ÏóÑÍ≤©Ìïú Ï°∞Í±¥)
    const patterns = [
        // Ï°∞ÏÇ¨ (Î™ÖÏÇ¨ Îí§Ïóê Î∂ôÎäî Í≤ΩÏö∞Îßå)
        /^(.{2,})(ÏùÄ|Îäî|Ïù¥|Í∞Ä|ÏùÑ|Î•º|ÏóêÏÑú|ÏóêÍ≤å|ÏúºÎ°ú|Î°ú|Ïùò|Í≥º|ÏôÄ|ÎèÑ|Îßå|Î∂ÄÌÑ∞|ÍπåÏßÄ)$/, 
        // ÎèôÏÇ¨/ÌòïÏö©ÏÇ¨ Ïñ¥ÎØ∏ (Ïñ¥Í∞ÑÏù¥ 2Í∏ÄÏûê Ïù¥ÏÉÅÏù∏ Í≤ΩÏö∞Îßå)
        /^(.{2,})(ÏóàÎã§|ÏïòÎã§|Í≤†Îã§|ÏäµÎãàÎã§|„ÖÇÎãàÎã§)$/, 
        // Î≥¥Ï°∞ÎèôÏÇ¨ (Î™ÖÏÇ¨ Îí§Ïóê Î∂ôÎäî Í≤ΩÏö∞Îßå)
        /^(.{2,})(ÌïòÎã§|ÎêòÎã§|Ïù¥Îã§)$/
    ];
    
    for (const pattern of patterns) {
        const match = word.match(pattern);
        if (match && match[1].length >= 2) {
            // Î∂ÑÎ¶¨Îêú Ïñ¥Í∞ÑÏù¥ ÏùòÎØ∏Í∞Ä ÏûàÎäîÏßÄ Ï∂îÍ∞Ä Í≤ÄÏ¶ù
            const stem = match[1];
            const suffix = match[2];
            
            // 'Îã§'Îßå Îã®ÎèÖÏúºÎ°ú Î∂ÑÎ¶¨ÎêòÎäî Í≤ÉÏùÑ Î∞©ÏßÄ
            if (suffix === 'Îã§' && stem.length < 2) {
                continue;
            }
            
            // ÏùºÎ∞òÏ†ÅÏù∏ Îã®Ïñ¥Îì§ÏùÄ Î∂ÑÎ¶¨ÌïòÏßÄ ÏïäÏùå
            const dontSplit = ['Í∑∏Îü∞Îç∞', 'Í∑∏Î¶¨Í≥†', 'ÌïòÏßÄÎßå', 'Í∑∏ÎûòÏÑú', 'ÎòêÌïú', 'Ïñ¥Ï†ú', 'Ïò§Îäò', 'ÎÇ¥Ïùº'];
            if (dontSplit.includes(word)) {
                continue;
            }
            
            return [stem, suffix];
        }
    }
    
    // Ìå®ÌÑ¥Ïóê ÎßûÏßÄ ÏïäÍ±∞ÎÇò Î∂ÑÎ¶¨ Ï°∞Í±¥ÏùÑ ÎßåÏ°±ÌïòÏßÄ ÏïäÏúºÎ©¥ Í∑∏ÎåÄÎ°ú Î∞òÌôò
    return [word];
}

// ÌÜ†ÌÅ∞ÏùÑ Î¨∏Ïû•ÏóêÏÑú ÏãúÍ∞ÅÏ†ÅÏúºÎ°ú Í∞ïÏ°∞
function highlightTokenInSentence(token, tokenIndex) {
    const container = document.getElementById('clickableSentence');
    const spans = container.querySelectorAll('.clickable-char');
    
    // ÌÜ†ÌÅ∞ ÏúÑÏπò Ï∞æÍ∏∞
    let searchStart = 0;
    for (let i = 0; i < tokenIndex; i++) {
        const prevToken = currentTokens[i] || '';
        searchStart = currentSentence.indexOf(prevToken, searchStart) + prevToken.length;
    }
    
    const tokenStart = currentSentence.indexOf(token, searchStart);
    if (tokenStart !== -1) {
        // Ìï¥Îãπ Î≤îÏúÑÏùò Î¨∏ÏûêÎì§ÏùÑ Í∞ïÏ°∞
        for (let i = tokenStart; i < tokenStart + token.length; i++) {
            if (spans[i]) {
                spans[i].classList.add('token-boundary');
                spans[i].style.animation = 'pulse 0.5s ease';
            }
        }
    }
}

// ÏûêÎèô ÌÜ†ÌÅ∞Ìôî ÏãúÏûë Î©îÏãúÏßÄ
function showAutoTokenizationStart() {
    const container = document.getElementById('tokenContainer');
    const startMsg = document.createElement('div');
    startMsg.id = 'autoTokenMsg';
    startMsg.style.cssText = 'background: linear-gradient(45deg, #2196f3, #1976d2); color: white; padding: 15px; border-radius: 10px; margin: 15px 0; text-align: center; font-weight: bold; animation: fadeIn 0.5s ease;';
    startMsg.innerHTML = 'ü§ñ AIÍ∞Ä ÏûêÎèôÏúºÎ°ú ÌÜ†ÌÅ∞ÌôîÎ•º ÏàòÌñâÌïòÍ≥† ÏûàÏäµÎãàÎã§...<br><small style="font-weight: normal; margin-top: 5px; display: block;">ÌïúÍµ≠Ïñ¥ Ïñ∏Ïñ¥ Ìå®ÌÑ¥ÏùÑ Î∂ÑÏÑùÌïòÏó¨ ÏùòÎØ∏ Îã®ÏúÑÎ°ú Î∂ÑÎ¶¨Ìï©ÎãàÎã§.</small>';
    
    container.insertBefore(startMsg, container.firstChild);
}

// ÏûêÎèô ÌÜ†ÌÅ∞Ìôî ÏôÑÎ£å Î©îÏãúÏßÄ
function showAutoTokenizationComplete() {
    const autoMsg = document.getElementById('autoTokenMsg');
    if (autoMsg) {
        autoMsg.style.background = 'linear-gradient(45deg, #4caf50, #45a049)';
        autoMsg.innerHTML = '‚úÖ ÏûêÎèô ÌÜ†ÌÅ∞ÌôîÍ∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!<br><small style="font-weight: normal; margin-top: 5px; display: block;">ÏÉùÏÑ±Îêú ÌÜ†ÌÅ∞Îì§ÏùÑ ÌôïÏù∏ÌïòÍ≥† ÌïÑÏöîÏãú ÏàòÎèôÏúºÎ°ú ÏàòÏ†ïÌï† Ïàò ÏûàÏäµÎãàÎã§.</small>';
        
        // 3Ï¥à ÌõÑ Î©îÏãúÏßÄ Ï†úÍ±∞
        setTimeout(() => {
            if (autoMsg) autoMsg.remove();
        }, 3000);
    }
}

function checkTokenizationComplete(){ if (currentTokens.length>0) document.getElementById('embeddingBtn').disabled=false; }

/* =========================
   Step3: ÏûÑÎ≤†Îî© + 3D
   ========================= */
// ÏûÑÎ≤†Îî© Î™®Îìú Ï†ÑÌôò
function switchEmbeddingMode(useReal) {
    useRealEmbeddings = useReal;
    
    // Î≤ÑÌäº Ïä§ÌÉÄÏùº ÏóÖÎç∞Ïù¥Ìä∏
    const simpleBtn = document.getElementById('simpleEmbBtn');
    const realBtn = document.getElementById('realEmbBtn');
    const infoDiv = document.getElementById('embeddingModeInfo');
    
    if (useReal) {
        simpleBtn.style.background = 'linear-gradient(45deg, #667eea, #764ba2)';
        realBtn.style.background = 'linear-gradient(45deg, #4caf50, #45a049)';
        realBtn.style.transform = 'scale(1.05)';
        simpleBtn.style.transform = 'scale(1)';
        infoDiv.innerHTML = 'ÌòÑÏû¨: üöÄ Ïã§Ï†ú Î™®Îç∏ ÏûÑÎ≤†Îî© (FastText ÌïúÍµ≠Ïñ¥ Î™®Îç∏ Í∏∞Î∞ò, PCA Ï∂ïÏÜå)';
        infoDiv.style.color = '#4caf50';
    } else {
        realBtn.style.background = 'linear-gradient(45deg, #667eea, #764ba2)';
        simpleBtn.style.background = 'linear-gradient(45deg, #4caf50, #45a049)';
        simpleBtn.style.transform = 'scale(1.05)';
        realBtn.style.transform = 'scale(1)';
        infoDiv.innerHTML = 'ÌòÑÏû¨: üìö ÍµêÏú°Ïö© Í∞ÑÎã® ÏûÑÎ≤†Îî© (ÏùòÎØ∏ Í∑∏Î£π Í∏∞Î∞ò)';
        infoDiv.style.color = '#666';
    }
    
    // Ïù¥ÎØ∏ ÏûÑÎ≤†Îî©Ïù¥ ÏÉùÏÑ±Îêú Í≤ΩÏö∞ Ïû¨ÏÉùÏÑ±
    if (currentTokens.length > 0) {
        showEmbeddings();
    }
}

function proceedToEmbedding(){
    if (currentTokens.length===0){ alert('Î®ºÏ†Ä ÌÜ†ÌÅ∞ÌôîÎ•º ÏôÑÎ£åÌï¥Ï£ºÏÑ∏Ïöî!'); return; }
    activateStep(3);
    showEmbeddings();
}
function showEmbeddings(){
    const cont = document.getElementById('embeddingGrid');
    cont.innerHTML=''; embeddings={}; wordColors={};
    const colors=['#FF6B6B','#4ECDC4','#45B7D1','#96CEB4','#FFEAA7','#DDA0DD','#98D8C8','#F7DC6F'];
    currentTokens.forEach((tok,idx)=>{
        setTimeout(()=>{
            const emb = generateEmbedding(tok);
            embeddings[tok]=emb; wordColors[tok]=colors[idx%colors.length];
            const card = createEmbeddingCard(tok, emb);
            cont.appendChild(card);
            if (idx===currentTokens.length-1){
                setTimeout(()=>{ setup3DVisualization(); document.getElementById('rnnBtn').disabled=false; }, 500);
            }
        }, idx*400);
    });
}
function createEmbeddingCard(word, vec){
    const card=document.createElement('div'); card.className='embedding-card fade-in';
    const wordDiv=document.createElement('div'); wordDiv.className='embedding-word'; wordDiv.textContent=word;
    
    // ÏûÑÎ≤†Îî© ÌÉÄÏûÖ ÌëúÏãú
    const typeDiv=document.createElement('div');
    const isRealEmb = useRealEmbeddings && realWordEmbeddings[word];
    typeDiv.style.cssText = `font-size: 0.8em; margin-bottom: 8px; padding: 4px 8px; border-radius: 12px; display: inline-block; font-weight: bold;`;
    if (isRealEmb) {
        typeDiv.textContent = 'üöÄ FastText';
        typeDiv.style.background = '#4caf50';
        typeDiv.style.color = 'white';
    } else {
        typeDiv.textContent = 'üìö Í∞ÑÎã® Î™®Îìú';
        typeDiv.style.background = '#e0e0e0';
        typeDiv.style.color = '#666';
    }
    
    const vDiv=document.createElement('div'); vDiv.className='vector-display'; vDiv.textContent='['+vec.map(v=>v.toFixed(2)).join(', ')+']';
    const bars=document.createElement('div'); bars.style.marginTop='10px';
    vec.forEach(v=>{
        const bar=document.createElement('div'); bar.className='dimension-bar';
        const fill=document.createElement('div'); fill.className='dimension-fill'; fill.style.width = `${Math.abs(v)*50 + 50}%`;
        bar.appendChild(fill); bars.appendChild(bar);
    });
    card.appendChild(wordDiv); card.appendChild(typeDiv); card.appendChild(vDiv); card.appendChild(bars);
    return card;
}

// 3D ÏãúÍ∞ÅÌôî
function setup3DVisualization(){
    canvas3D = document.getElementById('embedding3DCanvas');
    ctx3D = canvas3D.getContext('2d');
    let dragging=false, lastX=0, lastY=0;
    canvas3D.addEventListener('mousedown', e=>{ dragging=true; lastX=e.clientX; lastY=e.clientY; });
    canvas3D.addEventListener('mousemove', e=>{
        if (!dragging) return;
        const dx = e.clientX - lastX, dy = e.clientY - lastY;
        rotation3D.y += dx*0.01; rotation3D.x += dy*0.01;
        draw3DSpace(); lastX=e.clientX; lastY=e.clientY;
    });
    canvas3D.addEventListener('mouseup', ()=> dragging=false);
    draw3DSpace(); createWordLegend();
}
function drawAxes(){
    ctx3D.strokeStyle='#ccc'; ctx3D.lineWidth=1;
    // X
    ctx3D.strokeStyle='#ff4444'; ctx3D.beginPath();
    let a=project3D(-150,0,0), b=project3D(150,0,0); ctx3D.moveTo(a.x,a.y); ctx3D.lineTo(b.x,b.y); ctx3D.stroke();
    // Y
    ctx3D.strokeStyle='#44ff44'; ctx3D.beginPath();
    a=project3D(0,-150,0); b=project3D(0,150,0); ctx3D.moveTo(a.x,a.y); ctx3D.lineTo(b.x,b.y); ctx3D.stroke();
    // Z
    ctx3D.strokeStyle='#4444ff'; ctx3D.beginPath();
    a=project3D(0,0,-150); b=project3D(0,0,150); ctx3D.moveTo(a.x,a.y); ctx3D.lineTo(b.x,b.y); ctx3D.stroke();

    ctx3D.fillStyle='#666'; ctx3D.font='12px Arial'; ctx3D.textAlign='center';
    const xl=project3D(170,0,0); ctx3D.fillText('X', xl.x, xl.y);
    const yl=project3D(0,170,0); ctx3D.fillText('Y', yl.x, yl.y);
    const zl=project3D(0,0,170); ctx3D.fillText('Z', zl.x, zl.y);
}
function project3D(x,y,z){
    const cx=Math.cos(rotation3D.x), sx=Math.sin(rotation3D.x);
    const cy=Math.cos(rotation3D.y), sy=Math.sin(rotation3D.y);
    const cz=Math.cos(rotation3D.z), sz=Math.sin(rotation3D.z);
    let nx = x*cy - z*sy;
    let nz = x*sy + z*cy;
    let ny = y;
    x=nx; y=ny*cx - nz*sx; z=ny*sx + nz*cx;
    nx = x*cz - y*sz; ny = x*sz + y*cz;
    return { x: canvas3D.width/2 + nx, y: canvas3D.height/2 + ny, z };
}
function draw3DSpace(){
    ctx3D.clearRect(0,0,canvas3D.width, canvas3D.height);
    ctx3D.fillStyle='#f8f9fa'; ctx3D.fillRect(0,0,canvas3D.width, canvas3D.height);
    drawAxes();
    const pts=[];
    Object.entries(embeddings).forEach(([w,e])=>{
        const x=e[0]*100, y=e[1]*100, z=e[2]*100;
        const p=project3D(x,y,z);
        pts.push({word:w, x:p.x, y:p.y, z, color:wordColors[w]});
    });
    pts.sort((a,b)=>a.z - b.z);
    pts.forEach(pt=>{
        const size=Math.max(4, 8 + pt.z*0.02);
        const alpha=Math.max(0.3, 1 + pt.z*0.003);
        ctx3D.globalAlpha = alpha;
        ctx3D.fillStyle = pt.color;
        ctx3D.beginPath(); ctx3D.arc(pt.x, pt.y, size, 0, Math.PI*2); ctx3D.fill();
        ctx3D.fillStyle='#333'; ctx3D.font=`${Math.max(10, 12 + pt.z*0.01)}px Arial`;
        ctx3D.textAlign='center'; ctx3D.fillText(pt.word, pt.x, pt.y - size - 5);
    });
    ctx3D.globalAlpha=1;
}
function createWordLegend(){
    const c = document.getElementById('wordLegend'); c.innerHTML='';
    Object.entries(wordColors).forEach(([w,color])=>{
        const item=document.createElement('div'); item.className='legend-item';
        const dot=document.createElement('div'); dot.className='legend-color'; dot.style.background=color;
        const span=document.createElement('span'); span.textContent=w;
        item.appendChild(dot); item.appendChild(span); c.appendChild(item);
    });
}
function rotate3DView(axis){
    const ang = Math.PI/6;
    if (axis==='x') rotation3D.x += ang;
    if (axis==='y') rotation3D.y += ang;
    if (axis==='z') rotation3D.z += ang;
    draw3DSpace();
}
function reset3DView(){ rotation3D={x:0,y:0,z:0}; draw3DSpace(); }
function updateVisualizationWithNewWord(word){ if (canvas3D && ctx3D){ createWordLegend(); draw3DSpace(); setTimeout(()=>highlightWordIn3D(word),500);} }
function highlightWordIn3D(target){
    const e=embeddings[target]; if (!e) return;
    const p=project3D(e[0]*100, e[1]*100, e[2]*100);
    let t=0; const iv=setInterval(()=>{
        draw3DSpace();
        const size=15 + Math.sin(t*0.5)*5;
        ctx3D.strokeStyle='#ff4444'; ctx3D.lineWidth=3;
        ctx3D.beginPath(); ctx3D.arc(p.x,p.y,size,0,Math.PI*2); ctx3D.stroke();
        t++; if (t>20){ clearInterval(iv); draw3DSpace(); }
    },100);
}

/* =========================
   OOV Ï≤òÎ¶¨
   ========================= */
function processNewWord(){
    const newWord = document.getElementById('newWordInput').value.trim();
    const rc = document.getElementById('oovResult');
    if (!newWord){ alert('ÏÉàÎ°úÏö¥ Îã®Ïñ¥Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!'); return; }
    if (embeddings[newWord]){
        rc.innerHTML=''; const w=document.createElement('div');
        w.style.cssText='color:#ff9800; font-weight:bold;'; w.textContent=`"${newWord}"Îäî Ïù¥ÎØ∏ ÌïôÏäµÎêú Îã®Ïñ¥ÏûÖÎãàÎã§!`;
        rc.appendChild(w); return;
    }
    rc.innerHTML=''; const loading=document.createElement('div');
    loading.style.textAlign='center'; loading.textContent='ÏÉàÎ°úÏö¥ Îã®Ïñ¥ ÏûÑÎ≤†Îî© ÏÉùÏÑ± Ï§ë...'; rc.appendChild(loading);

    setTimeout(()=>{
        const res = generateOOVEmbedding(newWord);
        embeddings[newWord] = res.embedding;

        // ÏÉâÏÉÅ Ìï†Îãπ
        const alt=['#FF69B4','#20B2AA','#FFA500','#9370DB','#32CD32'];
        wordColors[newWord] = alt[Object.keys(wordColors).length % alt.length];

        rc.innerHTML='';
        const title=document.createElement('h4'); title.textContent=`‚úÖ "${newWord}" ÏûÑÎ≤†Îî© ÏÉùÏÑ± ÏôÑÎ£å!`; rc.appendChild(title);

        const embBox=document.createElement('div');
        embBox.style.cssText='background:#f5f5f5; padding:15px; border-radius:8px; margin:15px 0;';
        const st=document.createElement('strong'); st.textContent='ÏÉùÏÑ±Îêú ÏûÑÎ≤†Îî©:'; embBox.appendChild(st); embBox.appendChild(document.createElement('br'));
        const embText=document.createElement('span'); embText.textContent='['+res.embedding.map(v=>v.toFixed(3)).join(', ')+']';
        embBox.appendChild(embText); rc.appendChild(embBox);

        if (res.similarWords.length>0){
            const simDiv=document.createElement('div'); simDiv.style.margin='15px 0';
            const simTitle=document.createElement('strong'); simTitle.textContent='Ï∞∏Í≥†Ìïú Ïú†ÏÇ¨ Îã®Ïñ¥Îì§:'; simDiv.appendChild(simTitle);
            const ul=document.createElement('ul');
            res.similarWords.forEach(s=>{
                const li=document.createElement('li'); li.style.margin='8px 0';
                const lvl = s.similarity>0.6 ? 'high' : s.similarity>0.3 ? 'medium' : 'low';
                const txt = s.similarity>0.6 ? 'ÎÜíÏùå' : s.similarity>0.3 ? 'Î≥¥ÌÜµ' : 'ÎÇÆÏùå';
                li.textContent=`"${s.word}" `;
                const badge=document.createElement('span'); badge.className=`similarity-indicator ${lvl}-similarity`;
                badge.textContent=`${txt} (${(s.similarity*100).toFixed(1)}%)`;
                li.appendChild(badge); ul.appendChild(li);
            });
            simDiv.appendChild(ul); rc.appendChild(simDiv);

            const m=document.createElement('div');
            m.style.cssText='background:#e8f5e8; padding:12px; border-radius:8px; margin:15px 0;';
            const mi=document.createElement('strong'); mi.textContent='üí° Î∞©Î≤ï: ';
            const mt=document.createElement('span'); mt.textContent='Ïú†ÏÇ¨Ìïú Îã®Ïñ¥Îì§Ïùò ÏûÑÎ≤†Îî©ÏùÑ Í∞ÄÏ§ëÌèâÍ∑†ÌïòÏó¨ ÏÉàÎ°úÏö¥ ÏûÑÎ≤†Îî©ÏùÑ ÏÉùÏÑ±ÌñàÏäµÎãàÎã§.';
            m.appendChild(mi); m.appendChild(mt); rc.appendChild(m);
        } else {
            const m=document.createElement('div');
            m.style.cssText='background:#fff3e0; padding:12px; border-radius:8px; margin:15px 0;';
            const mi=document.createElement('strong'); mi.textContent='üí° Î∞©Î≤ï: ';
            const mt=document.createElement('span'); mt.textContent='Ïú†ÏÇ¨ Îã®Ïñ¥Î•º Ï∞æÏßÄ Î™ªÌï¥ Í∏∞Î≥∏ ÏûÑÎ≤†Îî©ÏùÑ ÏÉùÏÑ±ÌñàÏäµÎãàÎã§.';
            m.appendChild(mi); m.appendChild(mt); rc.appendChild(m);
        }

        const btns=document.createElement('div'); btns.style.cssText='text-align:center; margin:15px 0;';
        const vBtn=document.createElement('button'); vBtn.textContent='3D ÏãúÍ∞ÅÌôîÏóê Ï∂îÍ∞ÄÌïòÍ∏∞';
        vBtn.style.cssText='background:#4caf50; color:#fff; border:none; padding:10px 20px; border-radius:20px; cursor:pointer;';
        vBtn.onclick=()=>updateVisualizationWithNewWord(newWord);
        const tBtn=document.createElement('button'); tBtn.textContent='ÏòàÏ∏° ÌÖåÏä§Ìä∏ÌïòÍ∏∞';
        tBtn.style.cssText='background:#2196f3; color:#fff; border:none; padding:10px 20px; border-radius:20px; cursor:pointer; margin-left:10px;';
        tBtn.onclick=()=>{ if (!document.getElementById('step5').classList.contains('active')) activateStep(5); document.getElementById('predictionInput').value=newWord; predictNext(); };
        btns.appendChild(vBtn); btns.appendChild(tBtn); rc.appendChild(btns);

        document.getElementById('newWordInput').value='';
    },1500);
}

/* =========================
   Step4: RNN ÏàúÏ∞® Ï≤òÎ¶¨
   ========================= */
function proceedToRNN(){ activateStep(4); processRNNSequentially(); }
function processRNNSequentially(){
    const cont=document.getElementById('rnnContainer'); cont.innerHTML='';
    const title=document.createElement('h4'); title.textContent='RNNÏù¥ Í∞Å ÌÜ†ÌÅ∞ÏùÑ ÏàúÏ∞®Ï†ÅÏúºÎ°ú Ï≤òÎ¶¨Ìï©ÎãàÎã§:'; cont.appendChild(title);
    
    // RNN Ï∞®Ïõê ÏÑ§Ï†ï ÏïàÎÇ¥
    const dimInfo=document.createElement('div');
    dimInfo.style.cssText='background:#fff3e0; padding:15px; border-radius:10px; margin:15px 0; border-left:4px solid #ff9800;';
    dimInfo.innerHTML=`
        <strong>üîß RNN Ï≤òÎ¶¨ Î∞©Ïãù:</strong><br>
        ‚Ä¢ <strong>ÏûÖÎ†•:</strong> 5Ï∞®Ïõê ÏûÑÎ≤†Îî© Î≤°ÌÑ∞<br>
        ‚Ä¢ <strong>Hidden State:</strong> 5Ï∞®Ïõê (ÏûÖÎ†•Í≥º ÎèôÏùºÌïú ÌÅ¨Í∏∞ Ïú†ÏßÄ)<br>
        ‚Ä¢ <strong>Ï≤òÎ¶¨:</strong> ÌòÑÏû¨ ÏûÖÎ†• + Ïù¥Ï†Ñ ÏÉÅÌÉú ‚Üí ÏÉàÎ°úÏö¥ ÏÉÅÌÉú<br>
        <small style="color:#666;">üí° Ïã§Ï†ú RNNÏùÄ Ï†ïÎ≥¥ ÏÜêÏã§ÏùÑ ÏµúÏÜåÌôîÌïòÍ∏∞ ÏúÑÌï¥ ÏûÖÎ†• Ï∞®ÏõêÍ≥º Í∞ôÍ±∞ÎÇò Îçî ÌÅ∞ Hidden StateÎ•º ÏÇ¨Ïö©Ìï©ÎãàÎã§.</small>
    `;
    cont.appendChild(dimInfo);

    hiddenStates=[]; memoryBank=[]; learnedModel={};
    let idx=0;
    function next(){
        if (idx<currentTokens.length){
            const tok=currentTokens[idx], vec=embeddings[tok];

            const step=document.createElement('div'); step.className='rnn-step active fade-in';
            const prev = hiddenStates.length>0 ? hiddenStates[hiddenStates.length-1] : [0,0,0,0,0];
            // Ïã§Ï†ú RNN Í≥ÑÏÇ∞: ÌòÑÏû¨ ÏûÖÎ†•Í≥º Ïù¥Ï†Ñ hidden state Í≤∞Ìï©
            const newH = vec.map((v,i)=>(v*0.6 + prev[i]*0.4).toFixed(2)); // Í∞ÄÏ§ë Í≤∞Ìï©
            hiddenStates.push(newH);

            const inV=document.createElement('div'); inV.className='input-vector';
            const it=document.createElement('strong'); it.textContent=tok;
            const ibr=document.createElement('br');
            const iv=document.createElement('span'); iv.textContent='['+vec.map(v=>v.toFixed(2)).join(', ')+']';
            inV.appendChild(it); inV.appendChild(ibr); inV.appendChild(iv);

            const a1=document.createElement('div'); a1.className='arrow'; a1.textContent='‚Üí';

            const cell=document.createElement('div'); cell.className='rnn-cell'; cell.textContent='RNN';
            const cbr=document.createElement('br'); const small=document.createElement('small'); small.textContent='Í∞ÄÏ§ë Í≤∞Ìï© Ï≤òÎ¶¨...';
            cell.appendChild(cbr); cell.appendChild(small);

            const a2=document.createElement('div'); a2.className='arrow'; a2.textContent='‚Üí';

            const hS=document.createElement('div'); hS.className='hidden-state';
            const ht=document.createElement('span'); ht.textContent='Hidden State';
            const hbr=document.createElement('br'); const hv=document.createElement('span'); hv.textContent='['+newH.join(', ')+']';
            hS.appendChild(ht); hS.appendChild(hbr); hS.appendChild(hv);

            step.appendChild(inV); step.appendChild(a1); step.appendChild(cell); step.appendChild(a2); step.appendChild(hS);
            cont.appendChild(step);

            // Í∞ÑÎã® 'ÌïôÏäµ' : ÌòÑÏû¨ Îã®Ïñ¥ -> Îã§Ïùå Îã®Ïñ¥ ÏàòÏßë
            if (idx<currentTokens.length-1){
                const nextTok=currentTokens[idx+1];
                if (!learnedModel[tok]) learnedModel[tok]=[];
                learnedModel[tok].push(nextTok);
            }

            updateMemoryBank(tok);
            idx++;
            step.scrollIntoView({behavior:'smooth', block:'center'});
            setTimeout(next, 2000);
        } else {
            setTimeout(()=>{ document.getElementById('predictionBtn').disabled=false; highlightLongTermDependency(); }, 1000);
        }
    }
    next();
}
function updateMemoryBank(token){
    memoryBank.push(token);
    if (memoryBank.length>memoryCapacity) memoryBank.shift();

    const md=document.getElementById('memoryDisplay'); md.innerHTML='';
    if (memoryBank.length===0){ const sp=document.createElement('span'); sp.style.color='#666'; sp.textContent='ÏïÑÏßÅ Ï≤òÎ¶¨ ÏãúÏûë Ï†ÑÏûÖÎãàÎã§'; md.appendChild(sp); return; }

    memoryBank.forEach((w,idx)=>{
        const mi=document.createElement('div'); mi.className='memory-item'; mi.textContent=w;
        const st=document.createElement('div'); st.className='memory-strength'; st.style.width = `${100 - (memoryBank.length-idx-1)*30}%`; mi.appendChild(st);
        if (idx < memoryBank.length-2) mi.classList.add('fading');
        md.appendChild(mi);
    });
}
function highlightLongTermDependency(){
    const steps=document.querySelectorAll('.rnn-step');
    steps.forEach((st,idx)=>{
        const tok=currentTokens[idx];
        if (tok && (tok.includes('Í∑∏Í≤É')||tok.includes('Ïù¥Í≤É')||tok.includes('Ï†ÄÍ≤É'))){
            st.style.border='3px solid #f44336'; st.style.background='#ffebee';
            const refs=['Ï±Ö','Ïä§ÎßàÌä∏Ìè∞','ÏÇ¨Í≥º','Í≥µ','Ï∞®'];
            const hasRef = refs.some(r => memoryBank.some(m=>m.includes(r)));
            if (!hasRef){
                const warn=document.createElement('div');
                warn.style.cssText='background:#f44336;color:#fff;padding:10px;border-radius:5px;margin-top:10px;text-align:center;font-weight:bold;';
                warn.textContent='‚ö†Ô∏è Ï∞∏Ï°∞ ÎåÄÏÉÅÏùÑ Í∏∞ÏñµÌïòÏßÄ Î™ªÌï©ÎãàÎã§!';
                st.appendChild(warn);
            }
        }
    });
}

/* =========================
   Step5: ÏòàÏ∏°
   ========================= */
function proceedToPrediction(){ activateStep(5); }
function predictNext(){
    const input = document.getElementById('predictionInput').value.trim();
    const rc = document.getElementById('predictionResult');
    if (!input){ alert('ÏòàÏ∏°Ìï† Îã®Ïñ¥Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!'); return; }
    rc.innerHTML='<div style="text-align:center;">ÏòàÏ∏° Ï§ë...</div>';
    setTimeout(()=>{
        const preds = generatePredictions(input);
        displayPredictions(preds, input);
    }, 1000);
}
function generatePredictions(w){
    const preds=[];
    if (!embeddings[w]){
        const oov = generateOOVEmbedding(w);
        embeddings[w]=oov.embedding;
        preds.push({ word:'[ÏÉàÎ°úÏö¥ Îã®Ïñ¥ Ï≤òÎ¶¨Îê®]', confidence:0.8, source:'oov_processed',
            details:`"${w}"Îäî ÏÉàÎ°úÏö¥ Îã®Ïñ¥Î°ú Ïú†ÏÇ¨ Îã®Ïñ¥Î•º Ï∞∏Í≥†ÌïòÏó¨ Ï≤òÎ¶¨ÎêòÏóàÏäµÎãàÎã§.`});
    }
    if (learnedModel[w]){
        const nxt=learnedModel[w]; const cnt={};
        nxt.forEach(x=>{ cnt[x]=(cnt[x]||0)+1; });
        Object.entries(cnt).forEach(([word, c])=>{
            preds.push({ word, confidence: c/nxt.length, source:'direct' });
        });
    }
    if (embeddings[w]){
        Object.keys(embeddings).forEach(t=>{
            if (t!==w && t.length>1){
                const s = calculateEmbeddingSimilarity(w,t);
                if (s>0.4 && learnedModel[t]){
                    learnedModel[t].forEach(nw=>{
                        preds.push({ word:nw, confidence: s*0.6, source:'embedding_similarity',
                            details:`"${t}"ÏôÄ Ïú†ÏÇ¨ÌïòÏó¨ ÏòàÏ∏°Îê® (Ïú†ÏÇ¨ÎèÑ: ${(s*100).toFixed(1)}%)` });
                    });
                }
            }
        });
    }
    const g=findSemanticGroup(w);
    if (g!=='Í∏∞ÌÉÄ'){
        const gw=semanticGroups[g]||[];
        gw.forEach(ww=>{
            if (learnedModel[ww]){
                learnedModel[ww].forEach(nw=>{
                    preds.push({ word:nw, confidence:0.4, source:'semantic_group',
                        details:`Í∞ôÏùÄ ÏùòÎØ∏ Í∑∏Î£π("${g}")Ïùò Îã®Ïñ¥Îì§Î°úÎ∂ÄÌÑ∞ ÏòàÏ∏°` });
                });
            }
        });
    }
    const commonNext={
        'Ï±Ö':['ÏùÑ','Ïù¥','ÏùÑÏùΩÏóàÎã§','Ïù¥Ïû¨ÎØ∏ÏûàÎã§'],
        'Í∑∏Í≤É':['Ïù¥','ÏùÑ','Ïùò','Í≥º'],
        'Ï≤†Ïàò':['Îäî','Í∞Ä','ÏôÄ','Ïùò'],
        'ÎèÑÏÑúÍ¥Ä':['ÏóêÏÑú','Ïóê','Ïùò','ÏùÑ'],
        'Ïª¥Ìì®ÌÑ∞':['Î•º','Í∞Ä','Î°ú','ÏóêÏÑú'],
        'ÏÇ¨Îûë':['ÏùÄ','Ïù¥','ÏùÑ','ÌïòÎã§'],
        'ÌñâÎ≥µ':['Ìïú','ÌïòÎã§','Ïù¥','ÏùÑ']
    };
    Object.keys(commonNext).forEach(k=>{
        if (w.includes(k) || k.includes(w)){
            commonNext[k].forEach(nw=> preds.push({ word:nw, confidence:0.5, source:'common_pattern' }) );
        }
    });

    // Ï§ëÎ≥µ Ï†ïÎ¶¨
    const uniq={};
    preds.forEach(p=>{
        if (uniq[p.word]){
            uniq[p.word].confidence = Math.max(uniq[p.word].confidence, p.confidence);
            if (p.details) uniq[p.word].details = p.details;
        } else uniq[p.word]=p;
    });
    return Object.values(uniq).sort((a,b)=>b.confidence - a.confidence).slice(0,6);
}
function displayPredictions(preds, input){
    const c=document.getElementById('predictionResult');
    if (preds.length===0){
        c.innerHTML = `<div style="text-align:center; color:#f44336;"><strong>"${input}"</strong>Ïóê ÎåÄÌïú ÏòàÏ∏°ÏùÑ ÏÉùÏÑ±Ìï† Ïàò ÏóÜÏäµÎãàÎã§.<br><small>ÌïôÏäµ Îç∞Ïù¥ÌÑ∞Í∞Ä Î∂ÄÏ°±ÌïòÍ±∞ÎÇò Îã®Ïñ¥Î•º Ïù∏ÏãùÌïòÏßÄ Î™ªÌñàÏäµÎãàÎã§.</small></div>`;
        return;
    }
    c.innerHTML='';
    const h=document.createElement('h4'); h.textContent=`"${input}" Îã§ÏùåÏóê Ïò¨ Îã®Ïñ¥ ÏòàÏ∏°:`; c.appendChild(h);

    if (preds.some(p=>p.source==='oov_processed')){
        const o=document.createElement('div');
        o.style.cssText='background:#fff3e0; padding:15px; border-radius:10px; margin:15px 0; border-left:4px solid #ff9800;';
        o.innerHTML=`<strong>üÜï ÏÉàÎ°úÏö¥ Îã®Ïñ¥ Í∞êÏßÄ!</strong><br>"${input}"Îäî ÌïôÏäµÎêòÏßÄ ÏïäÏùÄ ÏÉàÎ°úÏö¥ Îã®Ïñ¥ÏûÖÎãàÎã§. Ïú†ÏÇ¨Ìïú Îã®Ïñ¥Îì§ÏùÑ Ï∞∏Í≥†ÌïòÏó¨ ÏòàÏ∏°ÏùÑ ÏÉùÏÑ±ÌñàÏäµÎãàÎã§.`;
        c.appendChild(o);
    }

    preds.forEach((p,i)=>{
        if (p.source==='oov_processed') return;
        const conf=(p.confidence*100).toFixed(1);
        const srcMap={'direct':'ÏßÅÏ†ë ÌïôÏäµ','embedding_similarity':'ÏûÑÎ≤†Îî© Ïú†ÏÇ¨ÎèÑ','semantic_group':'ÏùòÎØ∏ Í∑∏Î£π','common_pattern':'ÏùºÎ∞ò Ìå®ÌÑ¥','similarity':'Ïú†ÏÇ¨ÎèÑ Í∏∞Î∞ò'};
        const src=srcMap[p.source]||'Í∏∞ÌÉÄ';

        const box=document.createElement('div'); box.style.cssText='margin:15px 0; padding:15px; background:#f8f9fa; border-radius:10px;';
        const w=document.createElement('div'); w.className='predicted-word'; w.textContent=`${i+1}. ${p.word}`;
        const bar=document.createElement('div'); bar.className='confidence-bar';
        const fill=document.createElement('div'); fill.className='confidence-fill'; fill.style.width=`${conf}%`; fill.textContent=`${conf}% ÌôïÏã†`;
        bar.appendChild(fill);

        const det=document.createElement('div'); det.style.marginTop='10px';
        det.innerHTML = `<small style="color:#666;"><strong>Ï∂úÏ≤ò:</strong> ${src}${p.details?`<br><strong>ÏÑ∏Î∂ÄÏÇ¨Ìï≠:</strong> ${p.details}`:''}</small>`;

        box.appendChild(w); box.appendChild(bar); box.appendChild(det);
        c.appendChild(box);
    });

    const avg = preds.reduce((s,p)=>s+p.confidence,0)/preds.length;
    let col='#f44336', txt='ÎÇÆÏùå';
    if (avg>0.6){ col='#4caf50'; txt='ÎÜíÏùå'; }
    else if (avg>0.3){ col='#ff9800'; txt='Î≥¥ÌÜµ'; }

    const q=document.createElement('div');
    q.style.cssText='background:#e3f2fd; padding:15px; border-radius:10px; margin:20px 0; text-align:center;';
    q.innerHTML = `<strong>üìä ÏòàÏ∏° ÌíàÏßà:</strong> <span style="color:${col}; font-weight:bold;">${txt}</span><span style="color:#666; font-size:0.9em;"> (ÌèâÍ∑† ÌôïÏã†ÎèÑ: ${(avg*100).toFixed(1)}%)</span>`;
    c.appendChild(q);
}

/* =========================
   Î¨∏Ï†ú ÏÉÅÌô© ÌÖåÏä§Ìä∏/Í∞ïÏ°∞
   ========================= */
function testProblemCases(){
    const tests=[
        { input:'Í∑∏Í≤É', expected:'Ï±Ö', description:'"Í∑∏Í≤É"Ïù¥ "Ï±Ö"ÏùÑ Í∞ÄÎ¶¨ÌÇ§ÎäîÏßÄ ÌôïÏù∏ (Ïû•Í∏∞ ÏùòÏ°¥ÏÑ±)' },
        { input:'Ï±Ö', expected:'ÏùÑ', description:'"Ï±Ö" Îã§ÏùåÏóê Ïò¨ Ï°∞ÏÇ¨ ÏòàÏ∏°' },
        { input:'Ïª¥Ìì®ÌÑ∞', expected:'ÏÉàÎ°úÏö¥ Îã®Ïñ¥', description:'ÌïôÏäµÌïòÏßÄ ÏïäÏùÄ ÏÉàÎ°úÏö¥ Îã®Ïñ¥ Ï≤òÎ¶¨ (OOV)' },
        { input:'ÌñâÎ≥µ', expected:'Í∞êÏ†ï Í¥ÄÎ†®', description:'ÏùòÎØ∏ Í∑∏Î£π Í∏∞Î∞ò ÏÉà Îã®Ïñ¥ ÏòàÏ∏° (OOV)' }
    ];
    const pd = document.getElementById('problemDetails');
    pd.innerHTML='';
    const intro=document.createElement('p'); intro.textContent='Îã§Ïùå ÌÖåÏä§Ìä∏Îì§ÏùÑ ÏàòÌñâÌï¥ÏÑú RNNÏùò ÌïúÍ≥ÑÏôÄ Í∞úÏÑ†Ï†êÏùÑ ÌôïÏù∏Ìï¥Î≥¥ÏÑ∏Ïöî:'; pd.appendChild(intro);

    const ul=document.createElement('ul');
    tests.forEach(tc=>{
        const preds = generatePredictions(tc.input);
        let ok=false, msg='';
        if (tc.input==='Í∑∏Í≤É'){
            ok = preds.some(p=>p.word.includes('Ï±Ö')||p.word.includes('ÏùÑ')||p.word.includes('Ïù¥'));
            msg = ok ? '‚úÖ ÏùºÎ∂Ä ÏòàÏ∏° Í∞ÄÎä•' : '‚ùå Ï∞∏Ï°∞ ÎåÄÏÉÅ Ïó∞Í≤∞ Ïã§Ìå®';
        } else if (tc.input==='Ï±Ö'){
            ok = preds.some(p=>p.word.includes('ÏùÑ')||p.word.includes('Ïù¥'));
            msg = ok ? '‚úÖ Ïò¨Î∞îÎ•∏ ÏòàÏ∏°' : '‚ùå ÏòàÏ∏° Ïã§Ìå®';
        } else {
            const hasOOV = preds.some(p=>p.source==='oov_processed') || preds.length>0;
            ok = hasOOV; msg = ok ? '‚úÖ OOV Ï≤òÎ¶¨ ÏÑ±Í≥µ' : '‚ùå OOV Ï≤òÎ¶¨ Ïã§Ìå®';
        }
        const li=document.createElement('li');
        li.style.cssText=`margin:15px 0; padding:15px; background:${ok?'#e8f5e8':'#ffebee'}; border-radius:10px;`;
        li.innerHTML = `
            <strong>${tc.description}</strong><br>
            ÏûÖÎ†•: "${tc.input}" ‚Üí ÏòàÏÉÅ: "${tc.expected}"<br>
            Í≤∞Í≥º: <span style="color:${ok?'#4caf50':'#f44336'}; font-weight:bold;">${msg}</span><br>
            <div style="margin-top:10px;">
                <button style="background:#2196f3; color:#fff; border:none; padding:8px 16px; border-radius:15px; cursor:pointer; font-size:0.9em;"
                    onclick="document.getElementById('predictionInput').value='${tc.input}'; predictNext();">
                    ÏßÅÏ†ë ÌÖåÏä§Ìä∏
                </button>
                ${!embeddings[tc.input] ? `
                <button style="background:#ff9800; color:#fff; border:none; padding:8px 16px; border-radius:15px; cursor:pointer; font-size:0.9em; margin-left:5px;"
                    onclick="document.getElementById('newWordInput').value='${tc.input}'; processNewWord();">
                    OOV Ï≤òÎ¶¨ ÏãúÏó∞
                </button>`:''}
            </div>
        `;
        ul.appendChild(li);
    });
    pd.appendChild(ul);

    // Ï¢ÖÌï© Î∂ÑÏÑù(ÏôÑÏÑ±)
    const analysis=document.createElement('div');
    analysis.style.cssText='background:#fff3e0; padding:20px; border-radius:15px; margin:25px 0;';
    analysis.innerHTML = `
        <h4 style="color:#ef6c00; margin-bottom:15px;">üîç RNNÏùò ÌïúÍ≥ÑÏ†êÍ≥º Í∞úÏÑ†Ï†ê</h4>
        <ol style="margin-left:18px; line-height:1.7;">
            <li><strong>Ïû•Í∏∞ ÏùòÏ°¥ÏÑ± Î¨∏Ï†ú</strong>: Î©ÄÎ¶¨ Îñ®Ïñ¥ÏßÑ Îã®Ïñ¥ Í∞Ñ Í¥ÄÍ≥Ñ(Ïòà: "Í∑∏Í≤É" ‚Üî "Ï±Ö")Î•º Ïú†ÏßÄÌïòÍ∏∞ Ïñ¥Î†§ÏõÄ.</li>
            <li><strong>ÏàúÏ∞® Ï≤òÎ¶¨Ïùò Î≥ëÎ™©</strong>: Îã®Ïñ¥Î•º Ìïú Í∞úÏî© Ï≤òÎ¶¨ÌïòÏó¨ ÏÜçÎèÑÍ∞Ä ÎäêÎ¶¨Í≥† Î≥ëÎ†¨ÌôîÍ∞Ä Ïñ¥Î†§ÏõÄ.</li>
            <li><strong>Ï†ïÎ≥¥ ÏÜåÏã§</strong>: ÏùÄÎãâ ÏÉÅÌÉúÎßåÏúºÎ°ú Ï§ëÏöîÌïú Ï†ïÎ≥¥Í∞Ä Îí§Î°ú Í∞àÏàòÎ°ù Ìù¨ÎØ∏Ìï¥Ïßà Ïàò ÏûàÏùå.</li>
            <li><strong>Í∞úÏÑ† ÏïÑÏù¥ÎîîÏñ¥</strong>: Ï§ëÏöî Î∂ÄÎ∂ÑÏóê ÏßëÏ§ëÌïòÎäî <u>Ïñ¥ÌÖêÏÖò</u> ÏÇ¨Ïö© ‚Üí Ï†ÑÏ≤¥Î•º Ìïú Î≤àÏóê Î≥¥Í≥† Í∞ÄÏ§ëÏπòÎ°ú ÏÑ†ÌÉù.</li>
            <li><strong>Îã§Ïùå Îã®Í≥Ñ ÏòàÍ≥†</strong>: Î©ÄÌã∞-Ìó§Îìú Ïñ¥ÌÖêÏÖò, Î†àÏù¥Ïñ¥ Ï†ïÍ∑úÌôî, ÏûîÏ∞®Ïó∞Í≤∞ Îì±ÏùÑ Í∞ÄÏßÑ <u>Ìä∏ÎûúÏä§Ìè¨Î®∏</u>Î°ú ÌôïÏû•.</li>
        </ol>
    `;
    pd.appendChild(analysis);

    // ÏÑπÏÖò ÌëúÏãú Î∞è Ïä§ÌÅ¨Î°§
    const probSec=document.getElementById('problemSection');
    probSec.style.display='block';
    probSec.scrollIntoView({behavior:'smooth', block:'start'});
}

/* =========================
   ÌÄ¥Ï¶à ÏÑ†ÌÉù Ï≤òÎ¶¨
   ========================= */
let quizAnswered=false;
function selectAnswer(el, correct){
    if (quizAnswered) return;
    
    const options=document.querySelectorAll('.quiz-option');
    options.forEach(o=>{
        o.classList.remove('correct','wrong');
        o.style.pointerEvents = 'none'; // Î™®Îì† ÏÑ†ÌÉùÏßÄ ÎπÑÌôúÏÑ±Ìôî
    });
    
    if (correct){
        // Ï†ïÎãµ ÏÑ†ÌÉù Ïãú
        el.classList.add('correct');
        
        // Ï†ïÎãµ Ï∂ïÌïò Î©îÏãúÏßÄ ÌëúÏãú
        const congratsDiv = document.createElement('div');
        congratsDiv.style.cssText = 'background: linear-gradient(45deg, #4caf50, #45a049); color: white; padding: 15px; border-radius: 10px; margin: 15px 0; text-align: center; font-weight: bold; animation: fadeIn 0.5s ease;';
        congratsDiv.innerHTML = 'üéâ Ï†ïÎãµÏûÖÎãàÎã§! ÌõåÎ•≠Ìï¥Ïöî!';
        
        // ÌÄ¥Ï¶à Ïª®ÌÖåÏù¥ÎÑàÏóê Ï∂ïÌïò Î©îÏãúÏßÄ Ï∂îÍ∞Ä
        const quizContainer = document.querySelector('.quiz-container');
        const explanation = document.getElementById('quizExplanation');
        quizContainer.insertBefore(congratsDiv, explanation);
        
        // ÏÑ§Î™Ö ÌëúÏãú
        setTimeout(() => {
            document.getElementById('quizExplanation').style.display='block';
        }, 1000);
        
    } else {
        // Ïò§Îãµ ÏÑ†ÌÉù Ïãú
        el.classList.add('wrong');
        
        // ÌãÄÎ¶∞ ÎãµÏóê Îî∞Î•∏ Íµ¨Ï≤¥Ï†ÅÏù∏ ÌûåÌä∏ Ï†úÍ≥µ
        let hintMessage = '';
        const selectedText = el.textContent.trim();
        
        if (selectedText.includes('ÌÜ†ÌÅ∞Ìôî')) {
            hintMessage = 'üí° ÌûåÌä∏: ÌÜ†ÌÅ∞ÌôîÎäî Ï†ÑÏ≤òÎ¶¨ Îã®Í≥ÑÏûÖÎãàÎã§. RNN ÏûêÏ≤¥Ïùò Ï≤òÎ¶¨ Î∞©ÏãùÏóêÏÑú Ïò§Îäî Î¨∏Ï†úÎ•º ÏÉùÍ∞ÅÌï¥Î≥¥ÏÑ∏Ïöî!';
        } else if (selectedText.includes('ÏõåÎìú ÏûÑÎ≤†Îî©')) {
            hintMessage = 'üí° ÌûåÌä∏: ÏõåÎìú ÏûÑÎ≤†Îî©ÎèÑ Ï†ÑÏ≤òÎ¶¨ Îã®Í≥ÑÏûÖÎãàÎã§. RNNÏù¥ Ï†ïÎ≥¥Î•º Ï≤òÎ¶¨ÌïòÍ≥† Í∏∞ÏñµÌïòÎäî Î∞©ÏãùÏùò ÌïúÍ≥ÑÎ•º ÏÉùÍ∞ÅÌï¥Î≥¥ÏÑ∏Ïöî!';
        } else if (selectedText.includes('Ï†ïÌôïÎèÑÍ∞Ä ÎÑàÎ¨¥ ÎÜíÎã§')) {
            hintMessage = 'üí° ÌûåÌä∏: Ï†ïÌôïÎèÑÍ∞Ä ÎÜíÏùÄ Í≤ÉÏùÄ Î¨∏Ï†úÍ∞Ä ÏïÑÎãàÏóêÏöî! RNNÏù¥ Î¨∏Ïû•ÏùÑ ÏàúÏÑúÎåÄÎ°ú ÏùΩÏùÑ Îïå ÏïûÏ™Ω Ï†ïÎ≥¥Í∞Ä Ïñ¥ÎñªÍ≤å ÎêòÎäîÏßÄ ÏÉùÍ∞ÅÌï¥Î≥¥ÏÑ∏Ïöî.';
        } else {
            hintMessage = 'üí° ÌûåÌä∏: RNNÏùÄ Îã®Ïñ¥Î•º ÌïòÎÇòÏî© ÏàúÏÑúÎåÄÎ°ú Ï≤òÎ¶¨Ìï©ÎãàÎã§. Î¨∏Ïû•Ïù¥ Í∏∏Ïñ¥ÏßàÏàòÎ°ù Ï≤òÏùå Î∂ÄÎ∂ÑÏùò Ï†ïÎ≥¥Îäî Ïñ¥ÎñªÍ≤å Îê†ÍπåÏöî?';
        }
        
        // Ïò§Îãµ ÏïàÎÇ¥ Î©îÏãúÏßÄ ÌëúÏãú
        const incorrectDiv = document.createElement('div');
        incorrectDiv.style.cssText = 'background: linear-gradient(45deg, #ff9800, #f57c00); color: white; padding: 15px; border-radius: 10px; margin: 15px 0; text-align: center; font-weight: bold; animation: fadeIn 0.5s ease;';
        incorrectDiv.innerHTML = `‚ùå ÌãÄÎ†∏ÏäµÎãàÎã§. Îã§Ïãú ÏÉùÍ∞ÅÌï¥Î≥¥ÏÑ∏Ïöî!<br><small style="font-weight: normal; margin-top: 8px; display: block; line-height: 1.4;">${hintMessage}</small>`;
        
        // ÌÄ¥Ï¶à Ïª®ÌÖåÏù¥ÎÑàÏóê Ïò§Îãµ Î©îÏãúÏßÄ Ï∂îÍ∞Ä
        const quizContainer = document.querySelector('.quiz-container');
        const explanation = document.getElementById('quizExplanation');
        quizContainer.insertBefore(incorrectDiv, explanation);
        
        // Ïû¨ÏãúÎèÑ Î≤ÑÌäº Ï∂îÍ∞Ä
        const retryButton = document.createElement('button');
        retryButton.style.cssText = 'background: #2196f3; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; margin-top: 10px; font-size: 0.9em;';
        retryButton.textContent = 'üîÑ Îã§Ïãú ÏãúÎèÑÌïòÍ∏∞';
        retryButton.onclick = () => {
            // Ïò§Îãµ Î©îÏãúÏßÄ Ï†úÍ±∞
            incorrectDiv.remove();
            
            // Î™®Îì† ÏÑ†ÌÉùÏßÄ Ï¥àÍ∏∞Ìôî
            options.forEach(o => {
                o.classList.remove('correct', 'wrong');
                o.style.pointerEvents = 'auto';
            });
            
            quizAnswered = false;
        };
        incorrectDiv.appendChild(retryButton);
        
        return; // Ïò§ÎãµÏùº Í≤ΩÏö∞ Ïó¨Í∏∞ÏÑú Ìï®Ïàò Ï¢ÖÎ£å
    }
    
    quizAnswered=true;
}

/* =========================
   Ï¥àÍ∏∞ Î°úÎìú
   ========================= */
document.addEventListener('DOMContentLoaded', ()=>{
    // 1Îã®Í≥Ñ ÌôúÏÑ±Ìôî Î≥¥Ïû•
    activateStep(1);
});
</script>
</body>
</html>
